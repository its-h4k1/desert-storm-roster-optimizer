<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>ELT Admin · CSV & Dateien</title>
  <meta name="robots" content="noindex" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="admin.css" />
  <style>
    .admin-section h1 {
      margin-top: 0;
      margin-bottom: 0.35rem;
    }
    .admin-section p {
      margin: 0;
      color: var(--text-muted);
    }
    .card-grid .hint {
      font-size: 0.85rem;
    }
    .panel textarea {
      min-height: 240px;
    }
  </style>
</head>
<body class="admin-shell">
  <header class="admin-header">
    <div class="admin-brand">ELT Admin</div>
    <div class="admin-header-actions">
      <span id="envSite" class="pill mono"></span>
      <div id="authEmail" class="stat"></div>
      <button id="btnLogin" class="btn pri">Anmelden</button>
      <button id="btnLogout" class="btn err hidden">Abmelden</button>
      <a class="btn ghost" href="../index.html">Zur Roster-Ansicht</a>
    </div>
  </header>

  <div class="admin-layout">
    <nav class="admin-nav">
      <a href="index.html" class="active">CSV &amp; Datei-Tools</a>
      <a href="events.html">Events erfassen</a>
      <a href="players.html">Spieler &amp; Aliase</a>
      <a href="noshow-dashboard.html">No-Show Analyse</a>
    </nav>

    <main class="admin-content">
      <section class="admin-section">
        <h1>CSV &amp; Datei-Tools</h1>
        <p>Direkter Zugriff auf Allianz-, Alias-, Event- und Abwesenheits-Dateien inkl. Upload/Commit-Flow.</p>
        <div class="card-grid" style="margin-top:1.5rem;">
          <div class="card">
            <h3>Spieler &amp; Aliase</h3>
            <span class="hint">Neue Oberfläche für Alias-Verknüpfungen &amp; Details.</span>
            <a class="btn pri" href="players.html" style="margin-top:auto; width:max-content;">Zur Verwaltung</a>
          </div>
          <div class="card">
            <h3>No-Show Analyse</h3>
            <span class="hint">Dashboard auf Basis von <span class="code">out/latest.json</span>.</span>
            <a class="btn" href="noshow-dashboard.html" style="margin-top:auto; width:max-content;">Dashboard öffnen</a>
          </div>
        </div>
      </section>

      <section class="admin-section">
        <div class="tabs">
          <div class="tab active" data-tab="alliance">Allianzliste</div>
          <div class="tab" data-tab="aliases">Aliases</div>
          <div class="tab" data-tab="events">Event-CSV Upload</div>
          <div class="tab" data-tab="absences">Abwesenheiten</div>
        </div>

        <div class="panel">
          <!-- ALLIANCE -->
          <section id="tab-alliance">
            <div class="row"><div class="hint">Datei: <span class="code">data/alliance.csv</span></div></div>
            <div class="row two">
              <div>
                <label>CSV-Inhalt</label>
                <textarea id="taAlliance" rows="18" spellcheck="false" placeholder="PlayerName,InAlliance
itsH4K1,1
…"></textarea>
                <div class="row">
                  <button id="btnLoadAlliance" class="btn">Laden</button>
                  <button id="btnSaveAlliance" class="btn ok">Speichern</button>
                  <div id="msgAlliance" class="stat"></div>
                </div>
              </div>
              <div>
                <label>Format</label>
                <div class="hint">
                  <div><span class="code">PlayerName,InAlliance</span> (Header Pflicht; wird bei Bedarf automatisch ergänzt)</div>
                  <div>InAlliance kennzeichnet die Allianz-Mitgliedschaft: <span class="kbd">1</span> = In Allianz, <span class="kbd">0</span> = Ausgetreten</div>
                  <div class="hint" style="margin-top:1rem;">Roh-Datei live lesen: <span class="code">https://raw.githubusercontent.com/its-h4k1/desert-storm-roster-optimizer/main/data/alliance.csv</span></div>
                </div>
              </div>
            </div>
          </section>

          <!-- ALIASES -->
          <section id="tab-aliases" class="hidden">
            <div class="row"><div class="hint">Datei: <span class="code">data/aliases.csv</span></div></div>
            <div class="row two">
              <div>
                <label>CSV-Inhalt</label>
                <textarea id="taAliases" rows="18" spellcheck="false" placeholder="PlayerName,Alias,InAlliance
DarkSchredder,DarkWerwolf,0
…"></textarea>
                <div class="row">
                  <button id="btnLoadAliases" class="btn">Laden</button>
                  <button id="btnSaveAliases" class="btn ok">Speichern</button>
                  <div id="msgAliases" class="stat"></div>
                </div>
              </div>
              <div>
                <label>Format</label>
                <div class="hint">
                  <div><span class="code">PlayerName,Alias,InAlliance</span> (Header Pflicht; wird bei Bedarf automatisch ergänzt)</div>
                  <div>Die Spalte <span class="code">InAlliance</span> entscheidet, ob der Alias aktuell zur Allianz gehört (1 = In Allianz, 0 = Ausgetreten).</div>
                  <div>Beispiel: <span class="code">DarkSchredder,DarkWerwolf,0</span></div>
                  <div class="hint" style="margin-top:1rem;">Notiz: Bei mehrdeutigen Namen gewinnt die erste Zeile.</div>
                </div>
              </div>
            </div>
          </section>

          <!-- EVENTS -->
          <section id="tab-events" class="hidden">
            <div class="row"><div class="hint">Zielpfad standardmäßig unter <span class="code">data/</span>. Der Builder ignoriert <span class="code">alliance.csv</span> &amp; <span class="code">aliases.csv</span>, alles andere wird als Event interpretiert.</div></div>
            <div class="row">
              <div style="flex:1">
                <label>Event-CSV (Upload)</label>
                <input id="eventFile" type="file" accept=".csv,text/csv" />
              </div>
            </div>
            <div class="two">
              <div>
                <label>Vorschau Inhalt</label>
                <textarea id="taEventPreview" rows="14" spellcheck="false" placeholder="EventID,Slot,PlayerName,RoleAtRegistration,Teilgenommen,Punkte,Warnungen
DS-2025-11-07-A,1,itsH4K1,Start,1,1548053,"></textarea>
              </div>
              <div>
                <label>Zielpfad im Repo</label>
                <input id="eventPath" type="text" placeholder="data/DS-2025-11-07-A.csv" />
                <div class="hint">Tipp: Der Dateiname kann von der <span class="code">EventID</span> abgeleitet werden.</div>
                <div class="row" style="margin-top:0.75rem;">
                  <button id="btnUploadEvent" class="btn ok">Hochladen &amp; Commit</button>
                  <div id="msgEvent" class="stat"></div>
                </div>
              </div>
            </div>
          </section>

          <!-- ABSENCES -->
          <section id="tab-absences" class="hidden">
            <div class="row"><div class="hint">Datei: <span class="code">data/absences.csv</span> (wird erstellt, falls nicht vorhanden)</div></div>
            <div class="row two">
              <div>
                <label>CSV-Inhalt</label>
                <textarea id="taAbsences" rows="18" spellcheck="false" placeholder="PlayerName,From,To,Reason,InAlliance
itsH4K1,2025-11-14,2025-11-30,Ferien,1
…"></textarea>
                <div class="row">
                  <button id="btnLoadAbsences" class="btn">Laden</button>
                  <button id="btnSaveAbsences" class="btn ok">Speichern</button>
                  <div id="msgAbsences" class="stat"></div>
                </div>
              </div>
              <div>
                <label>Schnell-Eintrag</label>
                <div class="row">
                  <input id="absName" type="text" placeholder="PlayerName" />
                  <input id="absFrom" type="text" placeholder="From (YYYY-MM-DD)" />
                  <input id="absTo" type="text" placeholder="To (YYYY-MM-DD)" />
                  <input id="absReason" type="text" placeholder="Reason" />
                  <button id="btnAbsAdd" class="btn">Zeile anhängen</button>
                </div>
                <div class="hint" style="margin-top:0.75rem;">Beim Speichern wird die Datei committet. Der Roster-Builder kann diese Datei später berücksichtigen.</div>
              </div>
            </div>
          </section>
        </div>
      </section>
    </main>
  </div>

  <script src="admin.js"></script>
  <script>
    // ==== API-Konfiguration (Cloudflare Worker) ====
    const API_BASE = 'https://ds-commit.hak1.workers.dev';
    const WRITE_URL = API_BASE + '/write-file';
    const RAW_BASE = 'https://raw.githubusercontent.com/its-h4k1/desert-storm-roster-optimizer/main/';
    const TAB_KEY = 'ds_admin_tab';

    // UI helpers
    const $ = (s) => document.querySelector(s);
    const show = (el, on=true) => el.classList.toggle('hidden', !on);
    const msg = (el, text, ok=true) => { el.textContent = text; el.className = ok ? 'stat success' : 'stat error'; };

    // Anzeige der API-Base
    $('#envSite') && ($('#envSite').textContent = new URL(API_BASE).host);

    // Tabs
    function activateTab(name){
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${name}"]`)?.classList.add('active');
      document.querySelectorAll('section[id^="tab-"]').forEach(s => s.classList.add('hidden'));
      document.getElementById('tab-'+name)?.classList.remove('hidden');
      localStorage.setItem(TAB_KEY, name);
    }
    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => activateTab(t.dataset.tab)));
    const savedTab = localStorage.getItem(TAB_KEY); if (savedTab) activateTab(savedTab);

    // CSV utils
    const normalizeEOL = (t) => t.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const ensureFinalNewline = (t) => /\n$/.test(t) ? t : t + '\n';
    const ensureHeaderStrict = (text, header) => {
      const t = normalizeEOL(text).trimStart();
      if (!t) return header + '\n';
      const first = t.split('\n')[0].trim();
      return (first.toLowerCase() === header.toLowerCase())
        ? ensureFinalNewline(t)
        : header + '\n' + ensureFinalNewline(t);
    };

    const ensureHeaderPrefix = (text, prefixHeader) => {
      const norm = normalizeEOL(text);
      const trimmed = norm.replace(/^\s+/, '');
      if (!trimmed) return prefixHeader + '\n';
      const [firstLine, ...rest] = trimmed.split('\n');
      if (firstLine.toLowerCase().startsWith(prefixHeader.toLowerCase())) {
        return ensureFinalNewline([firstLine, ...rest].join('\n'));
      }
      return ensureFinalNewline(prefixHeader + '\n' + trimmed);
    };

    // ======= Einfacher Admin-Login (Shared Key) =======
    let ADMIN_KEY = localStorage.getItem('ds_admin_key') || '';
    const authEmail = $('#authEmail');
    const btnLogin = $('#btnLogin');
    const btnLogout = $('#btnLogout');

    function updateAuthUI() {
      if (ADMIN_KEY) { authEmail.textContent = 'Admin'; show(btnLogin,false); show(btnLogout,true); }
      else { authEmail.textContent = ''; show(btnLogin,true); show(btnLogout,false); }
    }
    updateAuthUI();

    btnLogin.addEventListener('click', () => {
      const k = prompt('Admin-Key eingeben (z. B. r4-admin)');
      if (k) { ADMIN_KEY = k.trim(); localStorage.setItem('ds_admin_key', ADMIN_KEY); updateAuthUI(); }
    });
    btnLogout.addEventListener('click', () => {
      ADMIN_KEY=''; localStorage.removeItem('ds_admin_key'); updateAuthUI();
    });

    async function authedFetch(url, options = {}) {
      if (!ADMIN_KEY) throw new Error('Nicht angemeldet (Admin-Key fehlt).');
      const headers = Object.assign({}, options.headers || {}, {
        'Content-Type': 'application/json',
        'X-Admin-Key': ADMIN_KEY,
      });
      return fetch(url, Object.assign({}, options, { headers }));
    }

    // ========= Lesen (raw GitHub) =========
    async function loadRaw(relPath){
      const res = await fetch(RAW_BASE + relPath + '?_=' + Date.now());
      if (!res.ok) throw new Error('Fetch failed: ' + res.status + ' ' + relPath);
      return await res.text();
    }

    // ========= Schreiben (Worker) =========
    async function saveFile(path, content, message='admin: update '+path){
      const res = await authedFetch(WRITE_URL, {
        method: 'POST',
        body: JSON.stringify({ path, content, message })
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok || !j.ok) {
        const detail = (j && (j.error || j.detail)) ? (j.error + (j.detail ? (' · ' + j.detail) : '')) : 'write-file failed';
        throw new Error(detail);
      }
      return j;
    }

    // ========= Allianz =========
    $('#btnLoadAlliance').addEventListener('click', async () => {
      const el = $('#msgAlliance'); msg(el, 'Lade…', true);
      try {
        const raw = await loadRaw('data/alliance.csv');
        $('#taAlliance').value = normalizeEOL(raw);
        msg(el, 'OK');
      } catch(e){ msg(el, String(e), false); }
    });

    $('#btnSaveAlliance').addEventListener('click', async () => {
      const el = $('#msgAlliance'); msg(el, 'Speichere…', true);
      try {
        const headerPrefix = 'PlayerName,InAlliance';
        const txt = ensureHeaderPrefix($('#taAlliance').value, headerPrefix);
        await saveFile('data/alliance.csv', txt);
        msg(el, 'Gespeichert ✓');
      } catch(e){ msg(el, String(e), false); }
    });

    // ========= Aliases =========
    $('#btnLoadAliases').addEventListener('click', async () => {
      const el = $('#msgAliases'); msg(el, 'Lade…', true);
      try {
        const raw = await loadRaw('data/aliases.csv');
        $('#taAliases').value = normalizeEOL(raw);
        msg(el, 'OK');
      } catch(e){
        $('#taAliases').value = 'PlayerName,Alias,InAlliance\n';
        msg(el, 'Neue Datei vorbereitet (noch nicht gespeichert).');
      }
    });

    $('#btnSaveAliases').addEventListener('click', async () => {
      const el = $('#msgAliases'); msg(el, 'Speichere…', true);
      try {
        const header = 'PlayerName,Alias,InAlliance';
        const txt = ensureHeaderStrict($('#taAliases').value, header);
        await saveFile('data/aliases.csv', txt);
        msg(el, 'Gespeichert ✓');
      } catch(e){ msg(el, String(e), false); }
    });

    // ========= Events =========
    $('#eventFile').addEventListener('change', async (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      const text = await f.text();
      const norm = normalizeEOL(text);
      $('#taEventPreview').value = norm;

      // Dateiname aus erster EventID ableiten
      try {
        const lines = norm.split('\n').filter(l => l.trim().length > 0);
        const headerLike = /^EventID/i.test(lines[0]);
        const firstData = headerLike ? lines[1] : lines[0];
        const eventId = (firstData || '').split(',')[0].trim();
        if (/^DS-\d{4}-\d{2}-\d{2}-[A-Z]$/.test(eventId)) {
          $('#eventPath').value = `data/${eventId}.csv`;
        }
      } catch {}
    });

    $('#btnUploadEvent').addEventListener('click', async () => {
      const el = $('#msgEvent'); msg(el, 'Hochladen…', true);
      const path = $('#eventPath').value.trim();
      let txt  = $('#taEventPreview').value;
      if (!path || !txt) { msg(el, 'Pfad und Inhalt erforderlich.', false); return; }
      const header = 'EventID,Slot,PlayerName,RoleAtRegistration,Teilgenommen,Punkte,Warnungen';
      txt = ensureHeaderStrict(txt, header);
      try {
        await saveFile(path, txt, `admin: add ${path}`);
        msg(el, `Gespeichert ✓ (${path})`);
      } catch(e){ msg(el, String(e), false); }
    });

    // ========= Abwesenheiten =========
    $('#btnLoadAbsences').addEventListener('click', async () => {
      const el = $('#msgAbsences'); msg(el, 'Lade…', true);
      try {
        const raw = await loadRaw('data/absences.csv');
        $('#taAbsences').value = normalizeEOL(raw);
        msg(el, 'OK');
      } catch(e){
        $('#taAbsences').value = 'PlayerName,From,To,Reason,InAlliance\n';
        msg(el, 'Neue Datei vorbereitet (noch nicht gespeichert).');
      }
    });

    $('#btnSaveAbsences').addEventListener('click', async () => {
      const el = $('#msgAbsences'); msg(el, 'Speichere…', true);
      try {
        const header = 'PlayerName,From,To,Reason,InAlliance';
        const txt = ensureHeaderStrict($('#taAbsences').value, header);
        await saveFile('data/absences.csv', txt);
        msg(el, 'Gespeichert ✓');
      } catch(e){ msg(el, String(e), false); }
    });

    $('#btnAbsAdd').addEventListener('click', () => {
      const name = $('#absName').value.trim();
      const from = $('#absFrom').value.trim();
      const to   = $('#absTo').value.trim();
      const rsn  = $('#absReason').value.trim();
      if (!name || !from || !to) { alert('PlayerName, From, To sind Pflicht.'); return; }
      const line = `${name},${from},${to},${rsn||''},1`;
      const ta = $('#taAbsences');
      ta.value = ensureFinalNewline(ta.value.replace(/\s*$/, '')) + line + '\n';
    });

    // Optional: initial Allianz laden
    $('#btnLoadAlliance').click();
  </script>
</body>
</html>
