<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Desert Storm · No-Show Analyse</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="admin.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha256-0NKJgpQwa4ZpQt2l6QIeoebgtMVcT8d+GtoEDK8n66g=" crossorigin="anonymous"></script>
  <style>
    :root {
      --bg:#f4f6fb; --panel:#ffffff; --panel-2:#f8fafc; --fg:#111111; --muted:#5f6b7b;
      --line:#dfe7f1; --acc:#2563eb; --warn:#f59e0b; --bad:#dc2626; --ok:#16a34a; --neutral:#94a3b8;
    }
    *{box-sizing:border-box}
    body {
      margin:0;
      font-family: "Inter",ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
      color:var(--fg);
      min-height:100vh;
      background:var(--bg);
    }
    .page-wrapper {
      background:var(--panel);
      border-radius:1rem;
      border:1px solid var(--line);
      box-shadow:0 18px 35px rgba(15,23,42,0.08);
    }
    .page-header {
      display:flex;
      align-items:center;
      gap:12px;
      padding:18px 24px;
      position:sticky;
      top:0;
      z-index:20;
      background:rgba(255,255,255,0.96);
      border-bottom:1px solid var(--line);
    }
    .page-header .brand { font-size:1rem; font-weight:600; letter-spacing:.3px; }
    .page-header .spacer { flex:1; }
    .page-header a { color:var(--acc); text-decoration:none; font-size:.9rem; }
    .page-header a:hover { color:#1d4ed8; }
    .page-main {
      padding:32px clamp(16px,4vw,64px) 80px;
      max-width:1200px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    h1 { margin:0; font-size:2rem; }
    p { margin:0; }
    .hint { color:var(--muted); font-size:.95rem; }
    .panel {
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      padding:20px 24px;
      box-shadow:0 12px 28px rgba(15,23,42,0.08);
    }
    .filters { display:flex; flex-wrap:wrap; gap:18px; align-items:flex-end; }
    .filter { flex:1 1 220px; }
    .filter label {
      font-size:.85rem;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }
    .chip-group {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip-group button {
      appearance:none;
      border:1px solid var(--line);
      background:var(--panel-2);
      color:var(--fg);
      padding:6px 12px;
      border-radius:999px;
      font-size:.9rem;
      cursor:pointer;
      transition:all .15s ease;
    }
    .chip-group button.active {
      border-color:var(--acc);
      color:#fff;
      background:var(--acc);
      font-weight:600;
    }
    .cards {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:18px;
    }
    .card { background:var(--panel-2); border-radius:16px; padding:16px; border:1px solid var(--line); min-height:110px; display:flex; flex-direction:column; justify-content:center; gap:8px; box-shadow:0 8px 18px rgba(15,23,42,0.08); }
    .card h3 {
      margin:0;
      font-size:1.6rem;
    }
    .card span { color:var(--muted); font-size:.9rem; }
    .chart-title { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; font-weight:600; }
    .stacked {
      display:flex;
      height:46px;
      overflow:hidden;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel-2);
    }
    .stacked div { height:100%; display:flex; align-items:center; justify-content:center; font-size:.85rem; font-weight:600; }
    .stacked .legend-label { font-size:.75rem; }
    .stacked .nodata { background:#e2e8f0; }
    .stacked .low { background:#fde68a; }
    .stacked .good { background:#bbf7d0; }
    .stacked .mid { background:#fef3c7; }
    .stacked .bad { background:#fecdd3; }
    .stacked .bad strong { color:#991b1b; }
    .legend-grid {
      display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; font-size:.85rem; color:var(--muted);
    }
    .legend-grid span::before {
      content:"";
      display:inline-block;
      width:10px; height:10px;
      border-radius:3px;
      margin-right:6px;
      vertical-align:middle;
    }
    .legend-grid .l-nodata::before { background:#e2e8f0; }
    .legend-grid .l-low::before { background:#fde68a; }
    .legend-grid .l-good::before { background:#bbf7d0; }
    .legend-grid .l-mid::before { background:#fef3c7; }
    .legend-grid .l-bad::before { background:#fecdd3; }
    .bar-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:18px;
    }
    .bar-card {
      background:var(--panel-2);
      border-radius:14px;
      border:1px solid var(--line);
      padding:12px 14px 16px;
      box-shadow:0 6px 16px rgba(15,23,42,0.08);
    }
    .bar-card header { display:flex; align-items:center; justify-content:space-between; font-size:.9rem; color:var(--muted); margin:0 0 12px; padding:0; border:none; background:none; position:static; }
    .bar {
      height:120px;
      background:linear-gradient(180deg,#eef2ff,#e0e7ff);
      border-radius:10px;
      border:1px solid var(--line);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .bar span {
      display:block;
      width:60%;
      background:var(--acc);
      border-radius:8px 8px 0 0;
      transition:height .25s ease;
    }
    .bar .label {
      position:absolute;
      bottom:8px;
      right:10px;
      font-weight:600;
      font-variant-numeric:tabular-nums;
    }
    .risk-list { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .player-card { background:var(--panel-2); border-radius:16px; border:1px solid var(--line); padding:14px 16px; display:flex; flex-direction:column; gap:6px; box-shadow:0 6px 16px rgba(15,23,42,0.08); }
    .player-card strong { font-size:1rem; }
    .player-card small { color:var(--muted); font-size:.8rem; }
    .risk-pill { display:inline-flex; align-items:center; gap:6px; font-weight:600; font-size:.95rem; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; }
    .risk-pill.good { background:#d1fae5; border-color:#bbf7d0; color:#166534; }
    .risk-pill.mid { background:#fef3c7; border-color:#fde68a; color:#92400e; }
    .risk-pill.bad { background:#fee2e2; border-color:#fecaca; color:#b91c1c; }
    .risk-pill.low { background:#fff7d6; border-color:#fde68a; color:#92400e; }
    .risk-pill.nodata { background:#e2e8f0; border-color:#cbd5f5; color:#475569; }
    .empty { color:var(--muted); font-style:italic; }
    .chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:24px; }
    canvas { max-width:100%; }
    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; font-size:.95rem; }
    thead { color:var(--muted); font-size:.85rem; background:#f1f5f9; }
    th, td { padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; }
    tbody tr:hover { background:#f8fafc; }
    .metric-pill { display:inline-flex; align-items:center; gap:6px; font-size:.85rem; border-radius:999px; padding:2px 10px; border:1px solid var(--line); background:#fff; }
    .metric-pill strong { font-size:1rem; }
    @media(max-width:640px){
      header { flex-wrap:wrap; }
      header .spacer { display:none; }
    }
  </style>
</head>
<body class="admin-shell">
  <header class="admin-header">
    <div class="admin-brand">ELT Admin</div>
    <div class="admin-header-actions">
      <a class="btn ghost" href="../index.html">Zur Roster-Ansicht</a>
    </div>
  </header>
  <div class="admin-layout">
    <nav class="admin-nav">
      <a href="index.html">CSV &amp; Datei-Tools</a>
      <a href="events.html">Events erfassen</a>
      <a href="players.html">Spieler &amp; Aliase</a>
      <a href="absences.html">Absenzen</a>
      <a href="group-preferences.html">Gruppenpräferenzen</a>
      <a href="noshow-dashboard.html" class="active">No-Show Analyse</a>
    </nav>
    <main class="admin-content">
      <section class="admin-section page-wrapper">
        <header class="page-header">
            <div class="brand">Desert Storm · No-Show Analyse</div>
            <div class="spacer"></div>
            <a href="../index.html">Zurück zur Admin-Startseite</a>
          </header>
        <main class="page-main">
            <section>
              <h1>No-Show Dashboard</h1>
              <p class="hint">Live-Daten aus <code>out/latest.json</code>. Vergleiche Gruppen, Rollen und Metriken, um den Effekt der EB-Roster zu beurteilen.</p>
            </section>

            <section class="panel">
              <div class="filters">
                <div class="filter">
                  <label>Metrik</label>
                  <div class="chip-group" data-filter="metric">
                    <button data-value="overall" class="active">No-Show (overall)</button>
                    <button data-value="rolling">No-Show (rolling)</button>
                  </div>
                </div>
                <div class="filter">
                  <label>Rolle</label>
                  <div class="chip-group" data-filter="role">
                    <button data-value="all" class="active">Alle</button>
                    <button data-value="Start">Start</button>
                    <button data-value="Ersatz">Ersatz</button>
                  </div>
                </div>
                <div class="filter">
                  <label>Gruppe</label>
                  <div class="chip-group" data-filter="group">
                    <button data-value="all" class="active">Alle</button>
                    <button data-value="A">A</button>
                    <button data-value="B">B</button>
                  </div>
                </div>
                <div class="filter">
                  <label>Minimale Anzahl Events</label>
                  <input type="range" min="0" max="10" value="0" id="minEvents" />
                  <div class="metric-pill">ab <strong id="minEventsValue">0</strong> Events</div>
                </div>
              </div>
            </section>

            <section class="panel">
              <div class="cards" id="summaryCards"></div>
            </section>

            <section class="panel">
              <div class="chart-title">Risikoverteilung <span class="hint" id="filterLabel"></span></div>
              <div id="riskStack" class="stacked"></div>
              <div class="legend-grid">
                <span class="l-nodata">Keine Historie</span>
                <span class="l-low">Wenig Daten (≤2 Events)</span>
                <span class="l-good">Grün &lt; 20%</span>
                <span class="l-mid">Gelb 20–35%</span>
                <span class="l-bad">Rot &gt; 35%</span>
              </div>
            </section>

            <section class="panel">
              <div class="chart-title">Verteilung &amp; Zusammenhänge</div>
              <div class="chart-grid">
                <div>
                  <div class="hint" style="margin-bottom:8px;">Histogramm der No-Show-Raten (in %)</div>
                  <canvas id="histogram"></canvas>
                  <p class="hint" id="histHint"></p>
                </div>
                <div>
                  <div class="hint" style="margin-bottom:8px;">Events vs. No-Show</div>
                  <canvas id="scatter"></canvas>
                  <p class="hint" id="scatterHint"></p>
                </div>
              </div>
            </section>

            <section class="panel">
              <div class="chart-title">Gruppenvergleich</div>
              <div class="bar-grid" id="groupBars"></div>
            </section>

            <section class="panel">
              <div class="chart-title">Top-Risiko-Spieler</div>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Gruppe</th>
                      <th>Rolle</th>
                      <th>Events</th>
                      <th>No-Show</th>
                    </tr>
                  </thead>
                  <tbody id="riskTable"></tbody>
                </table>
              </div>
            </section>

            <section class="panel">
              <div class="chart-title">Risikoreichste Spieler (Detailkarten)</div>
              <div class="risk-list" id="playerList"></div>
            </section>
          </main>
      </section>
    </main>
  </div>

  <script>
    const state = {
      players: [],
      groups: {},
      filtered: [],
      view: {
        metric: 'overall',
        role: 'all',
        group: 'all',
        minEvents: 0,
      },
    };

    const charts = { histogram: null, scatter: null };
    const HIGH_RISK_THRESHOLD = 0.5;

    const metricLabel = {
      overall: 'No-Show Overall',
      rolling: 'No-Show Rolling',
    };

    const bucketColors = {
      nodata: '#e2e8f0',
      low: '#fde68a',
      good: '#bbf7d0',
      mid: '#fef3c7',
      bad: '#fecdd3',
    };

    const $ = (sel) => document.querySelector(sel);
    const $all = (sel) => Array.from(document.querySelectorAll(sel));

    function bucketFromRate(rate, seen){
      if(!Number.isFinite(seen) || seen === 0) return 'nodata';
      if(seen <= 2) return 'low';
      if(!Number.isFinite(rate)) return 'nodata';
      if(rate < 0.20) return 'good';
      if(rate < 0.35) return 'mid';
      return 'bad';
    }

    function classify(player, metric){
      const rate = Number(player[`noshow_${metric}`]);
      const seen = Number(player.events_seen ?? 0);
      const misses = Number(player.noshow_count ?? 0);
      return { key: bucketFromRate(rate, seen), rate, seen, misses };
    }

    function initFilters(){
      document.querySelectorAll('.chip-group').forEach(group => {
        group.addEventListener('click', (ev) => {
          if(ev.target.tagName !== 'BUTTON') return;
          const value = ev.target.dataset.value;
          const key = group.dataset.filter;
          if(!value || !key) return;
          state.view[key] = value;
          group.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn === ev.target));
          applyFilters();
        });
      });
      const minSlider = $('#minEvents');
      minSlider?.addEventListener('input', (ev) => {
        state.view.minEvents = Number(ev.target.value);
        $('#minEventsValue').textContent = state.view.minEvents;
        applyFilters();
      });
    }

    function loadData(){
      const url = new URL(location.href);
      const branch = url.searchParams.get('branch') || 'main';
      const RAW = `https://raw.githubusercontent.com/its-h4k1/desert-storm-roster-optimizer/${branch}/out/latest.json?v=${Date.now()}`;
      fetch(RAW, { cache: 'no-store' })
        .then(res => {
          if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
          return res.json();
        })
        .then(json => {
          state.players = Array.isArray(json.players) ? json.players : [];
          state.groups = json.groups || {};
          applyFilters();
        })
        .catch(err => {
          console.error(err);
          const message = `Fehler beim Laden der Daten: ${err.message}`;
          $('#playerList').innerHTML = `<p class="empty">${message}</p>`;
          $('#riskTable').innerHTML = `<tr><td colspan="5" class="empty">${message}</td></tr>`;
        });
    }

    function applyFilters(){
      const { group, role, minEvents } = state.view;
      state.filtered = state.players.filter(p => {
        if(role !== 'all' && p.role !== role) return false;
        if(group !== 'all' && p.group !== group) return false;
        const seen = Number(p.events_seen ?? 0);
        if(seen < minEvents) return false;
        return true;
      });
      render();
    }

    function render(){
      renderSummary();
      renderRiskStack();
      renderGroupBars();
      renderHistogram();
      renderScatter();
      renderTopTable();
      renderTopPlayers();
    }

    function pct(value){
      if(!Number.isFinite(value)) return '–';
      return (value*100).toFixed(1) + '%';
    }

    function avg(arr){
      const vals = arr.filter(v => Number.isFinite(v));
      if(!vals.length) return null;
      return vals.reduce((a,b)=>a+b,0)/vals.length;
    }

    function median(arr){
      const vals = arr.filter(v => Number.isFinite(v)).sort((a,b)=>a-b);
      if(!vals.length) return null;
      const mid = Math.floor(vals.length/2);
      if(vals.length % 2) return vals[mid];
      return (vals[mid-1] + vals[mid]) / 2;
    }

    function renderSummary(){
      const players = state.filtered;
      const metricKey = `noshow_${state.view.metric}`;
      const rates = players.map(p => Number(p[metricKey]));
      const seen = players.map(p => Number(p.events_seen));
      const penalty = players.map(p => Number(p.risk_penalty));
      const avgRate = avg(rates);
      const medRate = median(rates);
      const avgSeen = avg(seen);
      const avgPenalty = avg(penalty);
      const highRisk = players.filter(p => Number(p[metricKey]) >= HIGH_RISK_THRESHOLD).length;

      const cards = [
        { label: 'Gefilterte Spieler', value: players.length ? players.length : '0', detail: `${state.view.group === 'all' ? 'Gruppen A+B' : 'Gruppe '+state.view.group}` },
        { label: metricLabel[state.view.metric], value: pct(avgRate), detail: 'Ø No-Show-Rate' },
        { label: 'Median No-Show', value: pct(medRate), detail: 'Robuste Mitte' },
        { label: 'Ø Events gesehen', value: Number.isFinite(avgSeen) ? avgSeen.toFixed(1) : '–', detail: `Min. Events ≥ ${state.view.minEvents}` },
        { label: 'Ø Risk Penalty', value: Number.isFinite(avgPenalty) ? avgPenalty.toFixed(1) : '–', detail: 'Builder-Input' },
        { label: `Hohes Risiko (> ${Math.round(HIGH_RISK_THRESHOLD*100)}%)`, value: highRisk, detail: 'Spieler im Filter' },
      ];
      const wrap = $('#summaryCards');
      wrap.innerHTML = cards.map(card => `
        <div class="card">
          <span>${card.label}</span>
          <h3>${card.value}</h3>
          <span>${card.detail}</span>
        </div>
      `).join('');
    }

    function renderRiskStack(){
      const bucketCounts = { nodata:0, low:0, good:0, mid:0, bad:0 };
      state.filtered.forEach(p => {
        const bucket = classify(p, state.view.metric).key;
        bucketCounts[bucket]++;
      });
      const total = state.filtered.length;
      const wrap = $('#riskStack');
      if(!total){
        wrap.innerHTML = '<div class="nodata" style="width:100%;justify-content:center;">Keine Spieler im Filter</div>';
        $('#filterLabel').textContent = '0 Spieler';
        return;
      }
      wrap.innerHTML = Object.entries(bucketCounts).map(([key,value]) => {
        if(value === 0) return '';
        const width = (value/total)*100;
        const label = `${Math.round(width)}%`;
        return `<div class="${key}" style="width:${width}%;">${width>8 ? `<span class="legend-label">${label}</span>` : ''}</div>`;
      }).join('');
      $('#filterLabel').textContent = `${state.filtered.length} Spieler · ${metricLabel[state.view.metric]}`;
    }

    function renderGroupBars(){
      const container = $('#groupBars');
      const groups = ['A','B'];
      const roles = ['Start','Ersatz'];
      const data = [];
      groups.forEach(g => {
        roles.forEach(r => {
          const subset = state.players.filter(p => {
            if(state.view.group !== 'all' && g !== state.view.group) return false;
            if(state.view.role !== 'all' && r !== state.view.role) return false;
            if(Number(p.events_seen ?? 0) < state.view.minEvents) return false;
            return p.group === g && p.role === r;
          });
          data.push({
            group: g,
            role: r,
            value: avg(subset.map(p => Number(p[`noshow_${state.view.metric}`]))),
            count: subset.length,
          });
        });
      });
      const maxVal = Math.max(...data.map(d => d.value || 0), 0.35);
      container.innerHTML = data
        .filter(d => d.count > 0)
        .map(d => {
          const height = d.value ? (d.value / maxVal) * 100 : 0;
          return `<div class="bar-card">
            <header><div>${d.group} · ${d.role}</div><div>${d.count} Spieler</div></header>
            <div class="bar"><span style="height:${height}%"></span><div class="label">${pct(d.value)}</div></div>
          </div>`;
        }).join('');
      if(!container.innerHTML){
        container.innerHTML = '<p class="empty">Keine Kombination entspricht dem Filter.</p>';
      }
    }

    function destroyChart(name){
      if(charts[name]){
        charts[name].destroy();
        charts[name] = null;
      }
      const canvasId = name === 'histogram' ? 'histogram' : name === 'scatter' ? 'scatter' : null;
      if(canvasId){
        const canvas = document.getElementById(canvasId);
        canvas?.getContext('2d')?.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    function renderHistogram(){
      const rates = state.filtered.map(p => Number(p[`noshow_${state.view.metric}`])).filter(v => Number.isFinite(v));
      const histHint = $('#histHint');
      if(!rates.length){
        histHint.textContent = 'Keine No-Show-Daten im aktuellen Filter.';
        destroyChart('histogram');
        return;
      }
      const bins = new Array(10).fill(0);
      rates.forEach(rate => {
        const idx = Math.max(0, Math.min(9, Math.floor(rate * 10)));
        bins[idx]++;
      });
      const labels = bins.map((_, idx) => `${idx*10}–${(idx+1)*10}%`);
      const colors = bins.map((_, idx) => {
        const center = ((idx + 0.5) / 10);
        return bucketColors[bucketFromRate(center, 5)] || bucketColors.good;
      });
      histHint.textContent = `${rates.length} Spieler mit No-Show-Raten in ${bins.filter(Boolean).length} Bins.`;
      const ctx = document.getElementById('histogram').getContext('2d');
      if(!charts.histogram){
        charts.histogram = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Spieler',
              data: bins,
              backgroundColor: colors,
            }],
          },
          options: {
            responsive: true,
            scales: {
              x: { grid: { color: 'rgba(255,255,255,.05)' } },
              y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,.05)' }, ticks: { precision:0 } },
            },
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: ctx => `${ctx.formattedValue} Spieler` } },
            },
          },
        });
      } else {
        charts.histogram.data.labels = labels;
        charts.histogram.data.datasets[0].data = bins;
        charts.histogram.data.datasets[0].backgroundColor = colors;
        charts.histogram.update();
      }
    }

    function renderScatter(){
      const metricKey = `noshow_${state.view.metric}`;
      const scatterHint = $('#scatterHint');
      const points = state.filtered.map(player => {
        const rate = Number(player[metricKey]);
        const seen = Number(player.events_seen ?? 0);
        const bucket = bucketFromRate(rate, seen);
        return { x: seen, y: Number.isFinite(rate) ? rate * 100 : null, player, color: bucketColors[bucket] || bucketColors.good };
      }).filter(p => Number.isFinite(p.y));
      if(!points.length){
        scatterHint.textContent = 'Keine validen Daten für Scatterplot.';
        destroyChart('scatter');
        return;
      }
      scatterHint.textContent = `${points.length} Spieler · x=Events, y=No-Show in %.`;
      const ctx = document.getElementById('scatter').getContext('2d');
      const dataset = {
        data: points,
        parsing: false,
        pointRadius: 6,
        pointHoverRadius: 7,
        backgroundColor: points.map(p => p.color),
      };
      if(!charts.scatter){
        charts.scatter = new Chart(ctx, {
          type: 'scatter',
          data: { datasets: [dataset] },
          options: {
            responsive: true,
            scales: {
              x: { title: { display:true, text:'Events gesehen' }, grid: { color: 'rgba(255,255,255,.05)' } },
              y: { title: { display:true, text:'No-Show in %' }, min: 0, max: 100, grid: { color: 'rgba(255,255,255,.05)' } },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => {
                    const player = ctx.raw.player;
                    return `${player.display}: ${ctx.raw.y.toFixed(1)}% · ${ctx.raw.x} Events`;
                  },
                },
              },
            },
          },
        });
      } else {
        charts.scatter.data.datasets[0].data = points;
        charts.scatter.data.datasets[0].backgroundColor = points.map(p => p.color);
        charts.scatter.update();
      }
    }

    function renderTopTable(){
      const tbody = $('#riskTable');
      const metricKey = `noshow_${state.view.metric}`;
      const rows = state.filtered
        .map(player => ({ player, rate: Number(player[metricKey]) }))
        .filter(item => Number.isFinite(item.rate))
        .sort((a,b) => b.rate - a.rate)
        .slice(0, 10);
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="5" class="empty">Keine Spieler im Filter.</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map(({ player, rate }) => `
        <tr>
          <td>${player.display}</td>
          <td>${player.group ?? '–'}</td>
          <td>${player.role ?? '–'}</td>
          <td>${player.events_seen ?? '–'}</td>
          <td>${pct(rate)}</td>
        </tr>
      `).join('');
    }

    function renderTopPlayers(){
      const metricKey = state.view.metric;
      const cards = state.filtered
        .map(p => ({
          player: p,
          rate: Number(p[`noshow_${metricKey}`]),
          bucket: classify(p, metricKey).key,
        }))
        .filter(item => Number.isFinite(item.rate))
        .sort((a,b) => b.rate - a.rate)
        .slice(0, 8);

      const wrap = $('#playerList');
      if(!cards.length){
        wrap.innerHTML = '<p class="empty">Keine Spieler im Filter.</p>';
        return;
      }
      wrap.innerHTML = cards.map(({ player, rate, bucket }) => {
        const badgeClass = `risk-pill ${bucket}`;
        const info = [player.group, player.role, `Events ${player.events_seen ?? '–'}`].filter(Boolean).join(' · ');
        return `<div class="player-card">
          <strong>${player.display}</strong>
          <small>${info}</small>
          <div class="${badgeClass}">${pct(rate)}</div>
          <small>No-Shows: ${player.noshow_count ?? '–'} · Risk Penalty: ${player.risk_penalty ?? '–'}</small>
        </div>`;
      }).join('');
    }

    initFilters();
    loadData();
  </script>
  <script src="admin.js"></script>
</body>
</html>
