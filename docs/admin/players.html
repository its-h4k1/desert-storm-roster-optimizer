<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <title>Spieler & Aliase verwalten</title>
  <link rel="stylesheet" href="admin.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
    }

    .page-header {
      background: var(--glass, rgba(255, 255, 255, 0.92));
      padding: 1.25rem clamp(1rem, 4vw, 2rem);
      border-radius: 1rem;
      border: 1px solid var(--border-strong, var(--border));
      box-shadow: var(--shadow-panel, 0 20px 45px rgba(15, 23, 42, 0.08));
      backdrop-filter: blur(18px);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
    }

    .page-header h1 {
      flex-basis: 100%;
      margin: 0;
      font-size: 1.45rem;
    }

    .page-header .settings {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    input[type="text"],
    input[type="search"],
    input[type="password"],
    textarea {
      font: inherit;
      padding: 0.5rem 0.65rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-alt);
      color: var(--text);
      min-width: clamp(12rem, 28vw, 20rem);
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
    }

    textarea {
      width: min(100%, 56rem);
      min-width: 0;
      resize: none;
      display: block;
    }

    input[type="search"] {
      min-width: 0;
    }

    input:focus,
    textarea:focus {
      outline: 2px solid rgba(37, 99, 235, 0.35);
      outline-offset: 1px;
    }

    button {
      font: inherit;
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.55rem 1.1rem;
      background: #fff;
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }

    button:hover {
      background: #f8fafc;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
    }

    button.secondary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    button.ghost {
      background: transparent;
      border-color: transparent;
      color: var(--accent);
    }

    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .page-main {
      flex: 1;
      padding: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      align-items: start;
    }

    .panel {
      background: var(--panel);
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      min-height: 400px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .panel h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .table-wrapper {
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      overflow: hidden;
      flex: 1;
      background: var(--panel-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    thead {
      background: #f1f5f9;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.04em;
    }

    th,
    td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    tbody tr {
      cursor: pointer;
    }

    tbody tr:nth-child(2n) {
      background: #f9fafc;
    }

    tbody tr:hover {
      background: rgba(37, 99, 235, 0.08);
    }

    tbody tr.selected {
      background: rgba(37, 99, 235, 0.18);
    }

    .status-hint {
      font-size: 0.75rem;
      color: #6b7280;
      display: block;
      margin-left: 1.6rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-flex;
      background: #d1d5db;
    }

    .status-dot.on {
      background: #0ba360;
    }

    .player-details h3 {
      margin: 0;
      font-size: 1.25rem;
    }

    .alias-table button {
      font-size: 0.8rem;
      padding: 0.3rem 0.6rem;
    }

    .alias-table table {
      font-size: 0.85rem;
    }

    .alias-table td {
      vertical-align: middle;
    }

    .detail-section {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 0.75rem;
      padding: 0.75rem;
      background: #fafbff;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .empty-state {
      margin: auto;
      text-align: center;
      color: #6b7280;
    }

    .status-bar {
      width: 100%;
      background: white;
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .status-bar span {
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      font-weight: 600;
    }

    .status-info {
      color: #1d4ed8;
      background: rgba(59, 130, 246, 0.12);
    }

    .status-ok {
      color: #0f7b43;
      background: rgba(16, 185, 129, 0.15);
    }

    .status-error {
      color: #991b1b;
      background: rgba(248, 113, 113, 0.18);
    }

    .status-warn {
      color: #92400e;
      background: rgba(251, 146, 60, 0.18);
    }

    .status-text {
      color: #4b5563;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(15, 23, 42, 0.08);
    }

    .hidden {
      display: none !important;
    }

    .tab-buttons {
      display: inline-flex;
      border: 1px solid rgba(15, 23, 42, 0.1);
      border-radius: 999px;
      overflow: hidden;
      background: white;
      align-self: flex-start;
    }

    .tab-button {
      border: none;
      background: transparent;
      color: #4b5563;
      padding: 0.35rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .tab-button.active {
      background: #0b63f6;
      color: white;
    }

    .tab-panel {
      margin-top: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .absence-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .absence-form {
      border: 1px dashed rgba(15, 23, 42, 0.2);
      border-radius: 0.75rem;
      padding: 0.75rem;
      background: rgba(11, 99, 246, 0.05);
    }

    .absence-form form {
      display: grid;
      gap: 0.75rem;
    }

    .absence-form .form-grid {
      display: grid;
      gap: 0.5rem;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .absence-form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      z-index: 30;
    }

    .modal:not(.hidden) {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      width: min(720px, 100%);
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.35);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
  
    @media (max-width: 720px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      header .settings {
        width: 100%;
      }
      label {
        width: 100%;
      }
      input[type="text"],
      input[type="password"],
      input[type="search"] {
        width: 100%;
      }
      button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body class="admin-shell">
  <header class="admin-header">
    <div class="admin-brand">ELT Admin</div>
    <div class="admin-header-actions">
      <a class="btn ghost" href="../index.html">Zur Roster-Ansicht</a>
    </div>
  </header>
  <div class="admin-layout">
    <nav class="admin-nav">
      <a href="index.html">CSV &amp; Datei-Tools</a>
      <a href="events.html">Events erfassen</a>
      <a href="players.html" class="active">Spieler &amp; Aliase</a>
      <a href="noshow-dashboard.html">No-Show Analyse</a>
    </nav>
    <main class="admin-content">
      <section class="admin-section page-wrapper">
        <header class="page-header">
            <div>
              <h1>Spieler &amp; Aliase verwalten</h1>
              <p style="margin:0;color:#6b7280;font-size:0.9rem">Pflege von <code>data/alliance.csv</code>, <code>data/aliases.csv</code> und <code>data/absences.csv</code></p>
            </div>
            <div class="settings">
              <label>Worker URL
                <input id="workerUrl" type="text" value="https://ds-commit.hak1.workers.dev/write-file" spellcheck="false">
              </label>
              <label>Branch
                <input id="branchInput" type="text" value="main" spellcheck="false">
              </label>
              <label>Admin-Key
                <input id="adminKey" type="password" placeholder="r4-admin" autocomplete="off">
              </label>
              <button id="reloadBtn" class="ghost">Neu laden</button>
              <button id="saveBtn">Speichern</button>
            </div>
          </header>
        <main class="page-main">
            <section class="panel">
              <div style="display:flex;flex-wrap:wrap;gap:0.75rem;align-items:center;">
                <h2 style="margin-right:auto">Spielerliste</h2>
                <label style="flex:1;min-width:180px">Suche
                  <input type="search" id="playerSearch" placeholder="Name filtern…">
                </label>
              </div>
              <div class="table-wrapper" aria-live="polite">
                <table>
                  <thead>
                    <tr id="playerHeaderRow"></tr>
                  </thead>
                  <tbody id="playersBody"></tbody>
                </table>
              </div>
            </section>

            <section class="panel player-details" id="detailsPanel">
              <div class="empty-state" id="emptyDetails">
                Bitte einen Spieler aus der Liste wählen.
              </div>
              <div id="detailsContent" class="detail-content" style="display:none; gap:1rem; flex-direction:column;">
                <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
                  <h3 id="detailName" style="flex:1;">–</h3>
                  <span class="pill" id="aliasCount">0 Aliase</span>
                </div>
                <div class="detail-section">
                  <strong>Spieler bearbeiten</strong>
                  <label> Name ändern
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                      <input type="text" id="renameInput" placeholder="Neuer Name">
                      <button id="renameBtn" class="secondary" style="flex:0 0 auto;">Übernehmen</button>
                    </div>
                  </label>
                  <div id="statusToggles" style="display:flex;gap:1rem;flex-wrap:wrap;"></div>
                </div>
                <div class="detail-section alias-table">
                  <div class="tab-buttons">
                    <button type="button" class="tab-button active" data-detail-tab="aliases" id="aliasesTabButton">Aliase</button>
                    <button type="button" class="tab-button" data-detail-tab="absences" id="absencesTabButton">Absenzen</button>
                  </div>
                  <div id="aliasTabPanel" class="tab-panel">
                    <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
                      <strong style="flex:1">Aliase</strong>
                      <button id="addAliasBtn" class="ghost" style="border:1px dashed rgba(15,23,42,0.3);">Alias hinzufügen</button>
                    </div>
                    <div class="table-wrapper" style="border:none;box-shadow:none;">
                      <table>
                        <thead>
                          <tr>
                            <th>Alias</th>
                            <th style="width:120px;">Aktionen</th>
                          </tr>
                        </thead>
                        <tbody id="aliasBody"></tbody>
                      </table>
                    </div>
                    <div class="empty-state" id="aliasEmpty" style="display:none;">Keine Aliase eingetragen.</div>
                  </div>
                  <div id="absenceTabPanel" class="tab-panel hidden">
                    <div class="table-wrapper" style="border:none;box-shadow:none;">
                      <table>
                        <thead>
                          <tr id="absenceHeaderRow"></tr>
                        </thead>
                        <tbody id="absenceBody"></tbody>
                      </table>
                    </div>
                    <div class="empty-state" id="absenceEmpty" style="display:none;">Keine Absenzen eingetragen.</div>
                    <div class="absence-actions">
                      <button id="addAbsenceBtn" class="ghost" style="border:1px dashed rgba(15,23,42,0.3);">Absenz hinzufügen</button>
                      <button id="showAllAbsencesBtn" class="secondary">Alle Absenzen des Spielers anzeigen</button>
                    </div>
                    <div id="absenceFormContainer" class="absence-form hidden"></div>
                  </div>
                </div>
              </div>
            </section>
          </main>
      </section>
    </main>
  </div>

  <div class="status-bar">
    <span id="statusBadge" class="status-info">Bereit</span>
    <div id="statusText" class="status-text">Noch keine Änderungen.</div>
  </div>

  <div id="absenceModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="absenceModalTitle">
    <div class="modal-content">
      <div style="display:flex;align-items:center;gap:0.75rem;justify-content:space-between;flex-wrap:wrap;">
        <strong id="absenceModalTitle">Absenzen</strong>
        <button id="closeAbsenceModal" type="button" class="ghost">Schließen</button>
      </div>
      <div id="absenceModalBody"></div>
    </div>
  </div>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    (function () {
      const elements = {
        workerUrl: document.getElementById("workerUrl"),
        branch: document.getElementById("branchInput"),
        adminKey: document.getElementById("adminKey"),
        reloadBtn: document.getElementById("reloadBtn"),
        saveBtn: document.getElementById("saveBtn"),
        playerSearch: document.getElementById("playerSearch"),
        playerHeaderRow: document.getElementById("playerHeaderRow"),
        playersBody: document.getElementById("playersBody"),
        emptyDetails: document.getElementById("emptyDetails"),
        detailsContent: document.getElementById("detailsContent"),
        detailName: document.getElementById("detailName"),
        aliasBody: document.getElementById("aliasBody"),
        aliasEmpty: document.getElementById("aliasEmpty"),
        aliasCount: document.getElementById("aliasCount"),
        addAliasBtn: document.getElementById("addAliasBtn"),
        aliasesTabButton: document.getElementById("aliasesTabButton"),
        absencesTabButton: document.getElementById("absencesTabButton"),
        aliasTabPanel: document.getElementById("aliasTabPanel"),
        absenceTabPanel: document.getElementById("absenceTabPanel"),
        absenceHeaderRow: document.getElementById("absenceHeaderRow"),
        absenceBody: document.getElementById("absenceBody"),
        absenceEmpty: document.getElementById("absenceEmpty"),
        addAbsenceBtn: document.getElementById("addAbsenceBtn"),
        showAllAbsencesBtn: document.getElementById("showAllAbsencesBtn"),
        absenceFormContainer: document.getElementById("absenceFormContainer"),
        absenceModal: document.getElementById("absenceModal"),
        absenceModalBody: document.getElementById("absenceModalBody"),
        closeAbsenceModal: document.getElementById("closeAbsenceModal"),
        renameInput: document.getElementById("renameInput"),
        renameBtn: document.getElementById("renameBtn"),
        statusToggles: document.getElementById("statusToggles"),
        statusBadge: document.getElementById("statusBadge"),
        statusText: document.getElementById("statusText"),
      };

      const state = {
        players: [],
        aliases: [],
        absences: [],
        selectedPlayerId: null,
        playerHeaders: [],
        aliasHeaders: ["Canonical", "Alias"],
        absenceHeaders: [],
        playerNameField: "PlayerName",
        aliasCanonicalField: "Canonical",
        aliasAliasField: "Alias",
        absencePlayerField: "PlayerName",
        statusFields: [],
        originalAllianceCsv: "",
        originalAliasesCsv: "",
        originalAbsencesCsv: "",
        loading: false,
        saving: false,
        nextAbsenceId: 0,
        activeDetailTab: "aliases",
      };

      const repoOwner = "its-h4k1";
      const repoName = "desert-storm-roster-optimizer";
      const defaultBranch = "main";
      const SETTINGS_KEY = "dsro-player-admin-settings";

      // Diese Spalten kodieren das Allianz-Membership-Flag (InAlliance==1 bedeutet "im Roster").
      const ALLIANCE_MEMBERSHIP_COLUMNS = [
        "InAlliance",
        "Active",
        "ActiveFlag",
        "ActiveStatus",
        "IsActive",
      ];
      const ALLIANCE_MEMBERSHIP_LABEL = "In Allianz";
      const ALLIANCE_MEMBERSHIP_HINT = "Wenn deaktiviert, gilt der Spieler als ausgetreten und wird im Roster ignoriert.";
      const DEFAULT_ABSENCE_HEADERS = ["PlayerName", "From", "To", "Reason", "InAlliance"];
      const ZERO_WIDTH_REGEX = /[\u200B-\u200F\u2060\uFEFF]/g;
      const HOMOGLYPH_MAP = {
        "А": "A",
        "В": "B",
        "Е": "E",
        "К": "K",
        "М": "M",
        "Н": "H",
        "О": "O",
        "Р": "P",
        "С": "S",
        "Т": "T",
        "Х": "X",
        "І": "I",
        "Ј": "J",
        "У": "Y",
        "а": "a",
        "е": "e",
        "о": "o",
        "р": "p",
        "с": "s",
        "х": "x",
        "у": "y",
        "к": "k",
        "м": "m",
        "т": "t",
        "н": "h",
        "і": "i",
        "ј": "j",
        "ѵ": "y",
      };
      const HOMOGLYPH_REGEX = new RegExp(`[${Object.keys(HOMOGLYPH_MAP).join("")}]`, "g");

      function isAllianceMembershipField(field) {
        return ALLIANCE_MEMBERSHIP_COLUMNS.includes(field);
      }

      function formatStatusLabel(field) {
        if (isAllianceMembershipField(field)) {
          return ALLIANCE_MEMBERSHIP_LABEL;
        }
        return field;
      }

      function normalizeLineEndings(text) {
        return (text || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
      }

      function ensureTrailingNewline(text) {
        if (!text) return "\n";
        return /\n$/.test(text) ? text : text + "\n";
      }

      function formatCsvValue(value) {
        if (value === null || value === undefined) return "";
        const str = value.toString();
        if (str.includes("\"") || str.includes(",") || str.includes("\n")) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      }

      function buildCsvFromRows(headers, rows) {
        const headerLine = headers.join(",");
        const lines = rows.map(row => {
          const values = headers.map(header => formatCsvValue(row[header] ?? ""));
          return values.join(",");
        });
        return ensureTrailingNewline([headerLine, ...lines].join("\n"));
      }

      function setStatus(message, tone = "info") {
        const badge = elements.statusBadge;
        const text = elements.statusText;
        badge.className = "status-" + tone;
        badge.textContent =
          tone === "ok" ? "OK" : tone === "error" ? "Fehler" : tone === "warn" ? "Hinweis" : "Status";
        text.textContent = message;
      }

      function setLoading(isLoading) {
        state.loading = isLoading;
        elements.reloadBtn.disabled = isLoading || state.saving;
        updateSaveButtonState();
        if (isLoading) {
          setStatus("Lade Spieler-, Alias- und Absenzdaten…", "info");
        }
      }

      function setSaving(isSaving) {
        state.saving = isSaving;
        updateSaveButtonState();
      }

      function updateSaveButtonState() {
        const hasChanges = hasAllianceChanged() || hasAliasChanged() || hasAbsenceChanged();
        elements.saveBtn.disabled = state.loading || state.saving || !hasChanges;
        elements.saveBtn.textContent = state.saving ? "Speichert…" : "Speichern";
      }

      function hasAllianceChanged() {
        const current = buildCurrentAllianceCsv();
        return normalizeLineEndings(current).trim() !== normalizeLineEndings(state.originalAllianceCsv).trim();
      }

      function hasAliasChanged() {
        const current = buildCurrentAliasCsv();
        return normalizeLineEndings(current).trim() !== normalizeLineEndings(state.originalAliasesCsv).trim();
      }

      function hasAbsenceChanged() {
        const current = buildCurrentAbsenceCsv();
        return normalizeLineEndings(current).trim() !== normalizeLineEndings(state.originalAbsencesCsv).trim();
      }

      function buildCurrentAllianceCsv() {
        const headers = state.playerHeaders.length ? state.playerHeaders : [state.playerNameField];
        const rows = state.players.map(player => player.rawRow);
        return buildCsvFromRows(headers, rows);
      }

      function buildCurrentAliasCsv() {
        const headers = state.aliasHeaders.length ? state.aliasHeaders : ["Canonical", "Alias"];
        const rows = state.aliases.map(alias => alias.rawRow);
        return buildCsvFromRows(headers, rows);
      }

      function buildCurrentAbsenceCsv() {
        const headers = state.absenceHeaders.length
          ? state.absenceHeaders
          : [state.absencePlayerField || "PlayerName"];
        const rows = state.absences
          .filter(absence => !absence.deleted)
          .map(absence => {
            const row = {};
            headers.forEach(header => {
              row[header] = absence.rawRow[header] ?? "";
            });
            return row;
          });
        return buildCsvFromRows(headers, rows);
      }

      function detectNameField(headers) {
        const candidates = ["PlayerName", "DisplayName", "Canonical", "Name"];
        return headers.find(header => candidates.includes(header)) || headers[0] || "PlayerName";
      }

      function detectAliasField(headers, preferred) {
        return headers.find(header => preferred.includes(header)) || preferred[0];
      }

      function detectAbsencePlayerField(headers) {
        if (!headers || !headers.length) return "PlayerName";
        const lowered = headers.map(header => (header || "").toString().toLowerCase());
        const priorities = ["playername", "player", "canonical", "name"];
        for (const candidate of priorities) {
          const idx = lowered.indexOf(candidate);
          if (idx !== -1) return headers[idx];
        }
        for (let i = 0; i < headers.length; i += 1) {
          const header = lowered[i];
          if (header.includes("player") || header.includes("name")) {
            return headers[i];
          }
        }
        return headers[0];
      }

      function normalizePlayerKey(value) {
        if (value === undefined || value === null) return "";
        let text = value.toString();
        if (typeof text.normalize === "function") {
          try {
            text = text.normalize("NFKC");
          } catch (err) {
            console.warn("Unicode-Normalisierung nicht möglich", err);
          }
        }
        text = text.replace(ZERO_WIDTH_REGEX, "");
        text = text.replace(HOMOGLYPH_REGEX, ch => HOMOGLYPH_MAP[ch] || ch);
        text = text.toLowerCase();
        text = text.replace(/\s+/g, " ").trim();
        return text;
      }

      async function fetchFirstAvailable(urls) {
        for (const url of urls) {
          try {
            const response = await fetch(url, { cache: "no-store" });
            if (response.ok) {
              return await response.text();
            }
          } catch (err) {
            console.warn("Fetch-Fallback fehlgeschlagen", url, err);
          }
        }
        throw new Error(`Keine Quelle erreichbar (${urls.join(", ")})`);
      }

      function buildCandidatePaths(path) {
        const cleanPath = path.replace(/^\/+/, "");
        const prefixes = ["../../", "../", "./", ""];
        const candidates = prefixes.map(prefix => `${prefix}${cleanPath}`.replace(/\/+/g, "/"));
        const rawUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${defaultBranch}/${cleanPath}`;
        candidates.push(rawUrl);
        return candidates;
      }

      async function loadAlliance() {
        const paths = buildCandidatePaths("data/alliance.csv");
        const text = await fetchFirstAvailable(paths);
        const normalized = ensureTrailingNewline(normalizeLineEndings(text));
        state.originalAllianceCsv = normalized;
        const parsed = Papa.parse(normalized, { header: true, skipEmptyLines: true });
        state.playerHeaders = parsed.meta.fields || [];
        state.playerNameField = detectNameField(state.playerHeaders);
        state.statusFields = state.playerHeaders.filter(header => ALLIANCE_MEMBERSHIP_COLUMNS.includes(header));
        state.players = (parsed.data || [])
          .map((row, index) => {
            const safeRow = { ...row };
            const canonical = (safeRow[state.playerNameField] || "").toString().trim();
            if (!canonical) return null;
            return {
              id: index,
              canonical,
              rawRow: safeRow,
            };
          })
          .filter(Boolean);
        if (state.players.length) {
          state.selectedPlayerId = state.players[0].id;
        } else {
          state.selectedPlayerId = null;
        }
      }

      async function loadAliases() {
        try {
          const paths = buildCandidatePaths("data/aliases.csv");
          const text = await fetchFirstAvailable(paths);
          const normalized = ensureTrailingNewline(normalizeLineEndings(text));
          state.originalAliasesCsv = normalized;
          const parsed = Papa.parse(normalized, { header: true, skipEmptyLines: true });
          state.aliasHeaders = parsed.meta.fields && parsed.meta.fields.length ? parsed.meta.fields : ["Canonical", "Alias"];
          state.aliasCanonicalField = detectAliasField(state.aliasHeaders, ["Canonical", "PlayerName", "Name"]);
          state.aliasAliasField = detectAliasField(state.aliasHeaders, ["Alias", "DisplayName"]);
          state.aliases = (parsed.data || [])
            .map((row, index) => {
              const safeRow = { ...row };
              const canonical = (safeRow[state.aliasCanonicalField] || "").toString().trim();
              const alias = (safeRow[state.aliasAliasField] || "").toString().trim();
              if (!canonical || !alias) return null;
              return {
                id: index,
                canonical,
                alias,
                rawRow: safeRow,
              };
            })
            .filter(Boolean);
        } catch (err) {
          console.warn("Aliases konnten nicht geladen werden, starte neu", err);
          state.aliasHeaders = ["Canonical", "Alias"];
          state.aliasCanonicalField = "Canonical";
          state.aliasAliasField = "Alias";
          state.aliases = [];
          state.originalAliasesCsv = ensureTrailingNewline("Canonical,Alias");
        }
      }

      async function loadAbsences() {
        let dataRows = [];
        try {
          const paths = buildCandidatePaths("data/absences.csv");
          const text = await fetchFirstAvailable(paths);
          const normalized = ensureTrailingNewline(normalizeLineEndings(text));
          state.originalAbsencesCsv = normalized;
          const parsed = Papa.parse(normalized, { header: true, skipEmptyLines: true });
          const headers = (parsed.meta.fields || []).filter(Boolean);
          state.absenceHeaders = headers.length ? headers : [...DEFAULT_ABSENCE_HEADERS];
          dataRows = parsed.data || [];
        } catch (err) {
          console.warn("Absences konnten nicht geladen werden, starte neu", err);
          state.absenceHeaders = [...DEFAULT_ABSENCE_HEADERS];
          state.originalAbsencesCsv = ensureTrailingNewline(DEFAULT_ABSENCE_HEADERS.join(","));
          dataRows = [];
        }
        state.absencePlayerField = detectAbsencePlayerField(state.absenceHeaders);
        if (!state.absenceHeaders.includes(state.absencePlayerField)) {
          state.absenceHeaders = [state.absencePlayerField, ...state.absenceHeaders];
        }
        state.absenceHeaders = Array.from(new Set(state.absenceHeaders.filter(Boolean)));
        state.absences = dataRows.map((row, index) => {
          const safeRow = {};
          state.absenceHeaders.forEach(header => {
            const rawValue = row && Object.prototype.hasOwnProperty.call(row, header) ? row[header] : "";
            safeRow[header] = rawValue === undefined || rawValue === null ? "" : String(rawValue);
          });
          const playerName = (safeRow[state.absencePlayerField] || "").toString().trim();
          return {
            id: index + 1,
            rawRow: safeRow,
            playerName,
            canonicalKey: normalizePlayerKey(playerName),
            deleted: false,
          };
        });
        state.nextAbsenceId = state.absences.reduce((max, item) => Math.max(max, item.id), 0) + 1;
      }

      async function reloadData() {
        setLoading(true);
        try {
          await loadAlliance();
          await loadAliases();
          await loadAbsences();
          renderPlayerHeader();
          renderPlayerTable();
          renderDetails();
          setStatus(
            `Geladen (${state.players.length} Spieler, ${state.aliases.length} Aliase, ${state.absences.length} Absenzen).`,
            "ok"
          );
        } catch (err) {
          console.error(err);
          setStatus(`Laden fehlgeschlagen: ${err.message}`, "error");
        } finally {
          setLoading(false);
          updateSaveButtonState();
        }
      }

      function renderPlayerHeader() {
        const row = elements.playerHeaderRow;
        row.innerHTML = "";
        const nameTh = document.createElement("th");
        nameTh.textContent = "Name";
        row.appendChild(nameTh);
        state.statusFields.forEach(field => {
          const th = document.createElement("th");
          th.textContent = formatStatusLabel(field);
          row.appendChild(th);
        });
      }

      function getFilteredPlayers() {
        const query = elements.playerSearch.value.trim().toLowerCase();
        return state.players
          .map(player => ({ ...player }))
          .filter(player => {
            if (!query) return true;
            return player.canonical.toLowerCase().includes(query);
          })
          .sort((a, b) => a.canonical.localeCompare(b.canonical, "de", { sensitivity: "base" }));
      }

      function renderPlayerTable() {
        const tbody = elements.playersBody;
        tbody.innerHTML = "";
        const players = getFilteredPlayers();
        players.forEach(player => {
          const tr = document.createElement("tr");
          if (player.id === state.selectedPlayerId) {
            tr.classList.add("selected");
          }
          tr.addEventListener("click", () => {
            state.selectedPlayerId = player.id;
            renderPlayerTable();
            renderDetails();
          });
          const nameTd = document.createElement("td");
          nameTd.textContent = player.canonical;
          tr.appendChild(nameTd);
          state.statusFields.forEach(field => {
            const td = document.createElement("td");
            const dot = document.createElement("span");
            dot.className = "status-dot";
            const value = player.rawRow[field];
            const isInAlliance = value === 1 || value === "1" || value === true || value === "true";
            if (isInAlliance) {
              dot.classList.add("on");
            }
            td.appendChild(dot);
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        if (!players.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = Math.max(1, 1 + state.statusFields.length);
          td.style.textAlign = "center";
          td.style.padding = "1.5rem";
          td.textContent = "Keine Spieler gefunden.";
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      }

      function getSelectedPlayer() {
        return state.players.find(player => player.id === state.selectedPlayerId) || null;
      }

      function renderDetails() {
        const player = getSelectedPlayer();
        if (!player) {
          elements.emptyDetails.style.display = "block";
          elements.detailsContent.style.display = "none";
          closeAbsenceForm();
          updateDetailTabs();
          return;
        }
        elements.emptyDetails.style.display = "none";
        elements.detailsContent.style.display = "flex";
        elements.detailName.textContent = player.canonical;
        elements.renameInput.value = player.canonical;
        renderStatusToggles(player);
        renderAliasTable(player);
        renderAbsenceTable(player);
        updateDetailTabs();
      }

      function renderStatusToggles(player) {
        const container = elements.statusToggles;
        container.innerHTML = "";
        if (!state.statusFields.length) {
          const note = document.createElement("div");
          note.style.color = "#6b7280";
          note.textContent = "Keine Statusfelder in alliance.csv gefunden.";
          container.appendChild(note);
          return;
        }
        state.statusFields.forEach(field => {
          const label = document.createElement("label");
          label.style.flexDirection = "column";
          label.style.alignItems = "flex-start";
          label.style.gap = "0.35rem";
          label.style.fontSize = "0.9rem";
          label.style.color = "#111827";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = player.rawRow[field] === 1 || player.rawRow[field] === "1" || player.rawRow[field] === true;
          checkbox.addEventListener("change", () => {
            player.rawRow[field] = checkbox.checked ? "1" : "0";
            renderPlayerTable();
            updateSaveButtonState();
            setStatus("Status geändert, bitte speichern.", "warn");
          });
          const textWrapper = document.createElement("div");
          textWrapper.style.display = "flex";
          textWrapper.style.alignItems = "center";
          textWrapper.style.gap = "0.5rem";
          const text = document.createElement("span");
          text.textContent = formatStatusLabel(field);
          textWrapper.appendChild(checkbox);
          textWrapper.appendChild(text);
          label.appendChild(textWrapper);
          if (isAllianceMembershipField(field)) {
            const hint = document.createElement("span");
            hint.className = "status-hint";
            hint.textContent = ALLIANCE_MEMBERSHIP_HINT;
            label.appendChild(hint);
          }
          container.appendChild(label);
        });
      }

      function renderAliasTable(player) {
        const tbody = elements.aliasBody;
        tbody.innerHTML = "";
        const rows = state.aliases.filter(alias => alias.canonical === player.canonical);
        elements.aliasCount.textContent = `${rows.length} Alias${rows.length === 1 ? "" : "e"}`;
        if (!rows.length) {
          elements.aliasEmpty.style.display = "block";
        } else {
          elements.aliasEmpty.style.display = "none";
        }
        rows
          .sort((a, b) => a.alias.localeCompare(b.alias, "de", { sensitivity: "base" }))
          .forEach(alias => {
            const tr = document.createElement("tr");
            const aliasTd = document.createElement("td");
            aliasTd.textContent = alias.alias;
            const actionTd = document.createElement("td");
            const btn = document.createElement("button");
            btn.className = "secondary";
            btn.textContent = "Löschen";
            btn.addEventListener("click", () => {
              removeAlias(alias.id);
            });
            actionTd.appendChild(btn);
            tr.appendChild(aliasTd);
            tr.appendChild(actionTd);
            tbody.appendChild(tr);
          });
        updateSaveButtonState();
      }

      function updateDetailTabs() {
        const isAliasTab = state.activeDetailTab === "aliases";
        if (elements.aliasesTabButton && elements.absencesTabButton) {
          elements.aliasesTabButton.classList.toggle("active", isAliasTab);
          elements.absencesTabButton.classList.toggle("active", !isAliasTab);
        }
        if (elements.aliasTabPanel && elements.absenceTabPanel) {
          elements.aliasTabPanel.classList.toggle("hidden", !isAliasTab);
          elements.absenceTabPanel.classList.toggle("hidden", isAliasTab);
        }
        if (isAliasTab) {
          closeAbsenceForm();
        }
      }

      function renderAbsenceHeader() {
        const row = elements.absenceHeaderRow;
        if (!row) return;
        row.innerHTML = "";
        const headers = state.absenceHeaders.length
          ? state.absenceHeaders
          : [state.absencePlayerField || "PlayerName"];
        headers.forEach(header => {
          const th = document.createElement("th");
          th.textContent = header;
          row.appendChild(th);
        });
        const actionTh = document.createElement("th");
        actionTh.textContent = "Aktionen";
        row.appendChild(actionTh);
      }

      function getAbsencesForPlayer(player) {
        if (!player) return [];
        const key = normalizePlayerKey(player.canonical);
        return state.absences.filter(absence => !absence.deleted && absence.canonicalKey === key);
      }

      function renderAbsenceTable(player) {
        renderAbsenceHeader();
        const tbody = elements.absenceBody;
        if (!tbody) return;
        tbody.innerHTML = "";
        const headers = state.absenceHeaders.length
          ? state.absenceHeaders
          : [state.absencePlayerField || "PlayerName"];
        const rows = player ? getAbsencesForPlayer(player) : [];
        rows.forEach(absence => {
          const tr = document.createElement("tr");
          headers.forEach(header => {
            const td = document.createElement("td");
            td.textContent = absence.rawRow[header] ?? "";
            tr.appendChild(td);
          });
          const actions = document.createElement("td");
          actions.style.whiteSpace = "nowrap";
          actions.style.display = "flex";
          actions.style.flexWrap = "wrap";
          actions.style.gap = "0.35rem";
          const editBtn = document.createElement("button");
          editBtn.className = "ghost";
          editBtn.textContent = "Bearbeiten";
          editBtn.addEventListener("click", () => editAbsence(absence.id));
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "secondary";
          deleteBtn.textContent = "Löschen";
          deleteBtn.addEventListener("click", () => deleteAbsence(absence.id));
          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
          tr.appendChild(actions);
          tbody.appendChild(tr);
        });
        if (elements.absenceEmpty) {
          elements.absenceEmpty.style.display = rows.length ? "none" : "block";
          if (!player) {
            elements.absenceEmpty.textContent = "Bitte zuerst einen Spieler auswählen.";
          } else {
            elements.absenceEmpty.textContent = "Keine Absenzen eingetragen.";
          }
        }
        if (elements.addAbsenceBtn) {
          elements.addAbsenceBtn.disabled = !player;
        }
        if (elements.showAllAbsencesBtn) {
          elements.showAllAbsencesBtn.disabled = !player || !rows.length;
        }
      }

      function closeAbsenceForm() {
        const container = elements.absenceFormContainer;
        if (!container) return;
        container.classList.add("hidden");
        container.innerHTML = "";
      }

      function addAbsenceForSelectedPlayer() {
        const player = getSelectedPlayer();
        if (!player) return;
        state.activeDetailTab = "absences";
        updateDetailTabs();
        openAbsenceForm("add", null);
      }

      function editAbsence(id) {
        const player = getSelectedPlayer();
        if (!player) return;
        const entry = state.absences.find(absence => absence.id === id && !absence.deleted);
        if (!entry) return;
        state.activeDetailTab = "absences";
        updateDetailTabs();
        openAbsenceForm("edit", entry);
      }

      function openAbsenceForm(mode, absence) {
        const player = getSelectedPlayer();
        if (!player) return;
        const container = elements.absenceFormContainer;
        container.classList.remove("hidden");
        container.innerHTML = "";
        const title = document.createElement("strong");
        title.textContent = mode === "edit" ? "Absenz bearbeiten" : "Neue Absenz";
        container.appendChild(title);
        const info = document.createElement("p");
        info.style.margin = "0";
        info.style.color = "#4b5563";
        info.textContent = "Spieler: ";
        const strong = document.createElement("strong");
        strong.textContent = player.canonical;
        info.appendChild(strong);
        container.appendChild(info);
        const form = document.createElement("form");
        const grid = document.createElement("div");
        grid.className = "form-grid";
        const headers = state.absenceHeaders.length
          ? state.absenceHeaders
          : [state.absencePlayerField || "PlayerName"];
        headers.forEach(header => {
          if (header === state.absencePlayerField) return;
          const label = document.createElement("label");
          label.textContent = header;
          const input = document.createElement("input");
          input.type = "text";
          input.name = header;
          const defaultValue = header.toLowerCase() === "active" ? "1" : "";
          input.value = absence ? absence.rawRow[header] ?? "" : defaultValue;
          label.appendChild(input);
          grid.appendChild(label);
        });
        if (!grid.children.length) {
          const note = document.createElement("div");
          note.textContent = "Keine editierbaren Spalten gefunden.";
          grid.appendChild(note);
        }
        form.appendChild(grid);
        const actions = document.createElement("div");
        actions.className = "absence-form-actions";
        const submitBtn = document.createElement("button");
        submitBtn.type = "submit";
        submitBtn.textContent = mode === "edit" ? "Speichern" : "Absenz anlegen";
        const cancelBtn = document.createElement("button");
        cancelBtn.type = "button";
        cancelBtn.className = "ghost";
        cancelBtn.textContent = "Abbrechen";
        cancelBtn.addEventListener("click", () => closeAbsenceForm());
        actions.appendChild(submitBtn);
        actions.appendChild(cancelBtn);
        form.appendChild(actions);
        form.addEventListener("submit", event => {
          event.preventDefault();
          submitAbsenceForm(mode, absence ? absence.id : null, new FormData(form));
        });
        container.appendChild(form);
      }

      function submitAbsenceForm(mode, absenceId, formData) {
        const player = getSelectedPlayer();
        if (!player) return;
        const headers = state.absenceHeaders.length
          ? state.absenceHeaders
          : [state.absencePlayerField || "PlayerName"];
        const values = {};
        headers.forEach(header => {
          if (header === state.absencePlayerField) return;
          const raw = formData.get(header);
          values[header] = raw === undefined || raw === null ? "" : String(raw).trim();
        });
        if (mode === "edit" && absenceId !== null) {
          const target = state.absences.find(item => item.id === absenceId);
          if (!target) return;
          headers.forEach(header => {
            if (header === state.absencePlayerField) {
              target.rawRow[header] = player.canonical;
            } else {
              target.rawRow[header] = values[header] ?? "";
            }
          });
          target.playerName = player.canonical;
          target.canonicalKey = normalizePlayerKey(player.canonical);
          setStatus("Absenz aktualisiert. Speichern nicht vergessen.", "warn");
        } else {
          const newRow = {};
          headers.forEach(header => {
            if (header === state.absencePlayerField) {
              newRow[header] = player.canonical;
            } else {
              newRow[header] = values[header] ?? "";
            }
          });
          const newAbsence = {
            id: state.nextAbsenceId++,
            rawRow: newRow,
            playerName: player.canonical,
            canonicalKey: normalizePlayerKey(player.canonical),
            deleted: false,
          };
          state.absences.push(newAbsence);
          setStatus("Absenz hinzugefügt. Speichern nicht vergessen.", "warn");
        }
        closeAbsenceForm();
        renderAbsenceTable(player);
        updateSaveButtonState();
      }

      function deleteAbsence(id) {
        const player = getSelectedPlayer();
        const entry = state.absences.find(absence => absence.id === id && !absence.deleted);
        if (!entry) return;
        if (!window.confirm("Absenz wirklich löschen?")) {
          return;
        }
        entry.deleted = true;
        closeAbsenceForm();
        renderAbsenceTable(player);
        updateSaveButtonState();
        setStatus("Absenz gelöscht. Speichern nicht vergessen.", "warn");
      }

      function showAllAbsencesForSelectedPlayer() {
        const player = getSelectedPlayer();
        if (!player) return;
        const rows = getAbsencesForPlayer(player);
        if (!rows.length) return;
        renderAbsenceModal(player, rows);
        elements.absenceModal.classList.remove("hidden");
      }

      function renderAbsenceModal(player, rows) {
        const body = elements.absenceModalBody;
        body.innerHTML = "";
        const info = document.createElement("p");
        info.style.margin = "0";
        info.textContent = `${rows.length} Absenz${rows.length === 1 ? "" : "en"} für ${player.canonical}`;
        body.appendChild(info);
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        const headers = state.absenceHeaders.length
          ? state.absenceHeaders
          : [state.absencePlayerField || "PlayerName"];
        headers.forEach(header => {
          const th = document.createElement("th");
          th.textContent = header;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        const tbody = document.createElement("tbody");
        rows.forEach(absence => {
          const tr = document.createElement("tr");
          headers.forEach(header => {
            const td = document.createElement("td");
            td.textContent = absence.rawRow[header] ?? "";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(thead);
        table.appendChild(tbody);
        body.appendChild(table);
      }

      function closeAbsenceModal() {
        elements.absenceModal.classList.add("hidden");
        elements.absenceModalBody.innerHTML = "";
      }

      function removeAlias(id) {
        const before = state.aliases.length;
        state.aliases = state.aliases.filter(alias => alias.id !== id);
        if (state.aliases.length !== before) {
          renderDetails();
          updateSaveButtonState();
          setStatus("Alias entfernt, bitte speichern.", "warn");
        }
      }

      function canonicalExists(name, ignoreId) {
        const norm = name.toLowerCase();
        return state.players.some(player => player.id !== ignoreId && player.canonical.toLowerCase() === norm);
      }

      function aliasExists(name) {
        const norm = name.toLowerCase();
        return state.aliases.some(alias => alias.alias.toLowerCase() === norm);
      }

      function addAlias() {
        const player = getSelectedPlayer();
        if (!player) return;
        const value = window.prompt(`Neuen Alias für ${player.canonical} eingeben:`);
        if (!value) return;
        const trimmed = value.trim();
        if (!trimmed) return;
        if (canonicalExists(trimmed, player.id) || aliasExists(trimmed)) {
          setStatus("Alias bereits vorhanden.", "error");
          return;
        }
        const newRow = {};
        state.aliasHeaders.forEach(header => {
          newRow[header] = "";
        });
        newRow[state.aliasCanonicalField] = player.canonical;
        newRow[state.aliasAliasField] = trimmed;
        const alias = {
          id: Date.now(),
          canonical: player.canonical,
          alias: trimmed,
          rawRow: newRow,
        };
        state.aliases.push(alias);
        renderDetails();
        updateSaveButtonState();
        setStatus("Alias hinzugefügt. Speichern nicht vergessen.", "warn");
      }

      function applyPlayerRename() {
        const player = getSelectedPlayer();
        if (!player) return;
        const newName = elements.renameInput.value.trim();
        if (!newName) {
          setStatus("Name darf nicht leer sein.", "error");
          return;
        }
        if (newName === player.canonical) {
          setStatus("Keine Änderung erkannt.", "info");
          return;
        }
        if (canonicalExists(newName, player.id) || aliasExists(newName)) {
          setStatus("Name bereits als Spieler oder Alias vorhanden.", "error");
          return;
        }
        const oldName = player.canonical;
        player.canonical = newName;
        player.rawRow[state.playerNameField] = newName;
        state.aliases.forEach(alias => {
          if (alias.canonical === oldName) {
            alias.canonical = newName;
            alias.rawRow[state.aliasCanonicalField] = newName;
          }
        });
        const oldKey = normalizePlayerKey(oldName);
        const newKey = normalizePlayerKey(newName);
        state.absences.forEach(absence => {
          if (absence.canonicalKey === oldKey) {
            absence.playerName = newName;
            absence.canonicalKey = newKey;
            absence.rawRow[state.absencePlayerField] = newName;
          }
        });
        renderPlayerTable();
        renderDetails();
        updateSaveButtonState();
        setStatus(`Spieler umbenannt von ${oldName} zu ${newName}.`, "warn");
      }

      async function saveChanges() {
        if (state.loading || state.saving) return;
        const workerUrl = elements.workerUrl.value.trim();
        const adminKey = elements.adminKey.value.trim();
        const branch = elements.branch.value.trim() || defaultBranch;
        if (!workerUrl) {
          setStatus("Worker-URL fehlt.", "error");
          return;
        }
        if (!adminKey) {
          setStatus("Admin-Key erforderlich.", "error");
          return;
        }
        const payloads = [];
        const allianceCsv = buildCurrentAllianceCsv();
        if (hasAllianceChanged()) {
          payloads.push({
            path: "data/alliance.csv",
            content: allianceCsv,
            message: "admin: update alliance.csv via players ui",
            branch,
          });
        }
        const aliasCsv = buildCurrentAliasCsv();
        if (hasAliasChanged()) {
          payloads.push({
            path: "data/aliases.csv",
            content: aliasCsv,
            message: "admin: update aliases.csv via players ui",
            branch,
          });
        }
        const absenceCsv = buildCurrentAbsenceCsv();
        if (hasAbsenceChanged()) {
          payloads.push({
            path: "data/absences.csv",
            content: absenceCsv,
            message: "admin: update absences.csv via players ui",
            branch,
          });
        }
        if (!payloads.length) {
          setStatus("Keine Änderungen zum Speichern.", "info");
          return;
        }
        setSaving(true);
        setStatus("Speichere Änderungen…", "info");
        try {
          for (const payload of payloads) {
            await writeFile(workerUrl, adminKey, payload);
          }
          state.originalAllianceCsv = allianceCsv;
          state.originalAliasesCsv = aliasCsv;
          state.originalAbsencesCsv = absenceCsv;
          setStatus("Spieler, Aliase und Absenzen gespeichert.", "ok");
        } catch (err) {
          console.error(err);
          setStatus(`Speichern fehlgeschlagen: ${err.message}`, "error");
        } finally {
          setSaving(false);
          updateSaveButtonState();
        }
      }

      async function writeFile(workerUrl, adminKey, payload) {
        const headers = { "Content-Type": "application/json", "X-Admin-Key": adminKey };
        const response = await fetch(workerUrl, {
          method: "POST",
          headers,
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          const text = await response.text().catch(() => "");
          throw new Error(text || `HTTP ${response.status}`);
        }
        const result = await response.json().catch(() => ({}));
        if (result && result.ok === false) {
          throw new Error(result.error || "Worker-Fehler");
        }
        return result;
      }

      function restoreSettings() {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            if (parsed.workerUrl) elements.workerUrl.value = parsed.workerUrl;
            if (parsed.branch) elements.branch.value = parsed.branch;
            if (parsed.adminKey) elements.adminKey.value = parsed.adminKey;
            return;
          } catch (err) {
            console.warn("Settings konnten nicht gelesen werden", err);
          }
        }
        const shared = localStorage.getItem("dsro-admin-settings");
        if (shared) {
          try {
            const parsed = JSON.parse(shared);
            if (parsed.workerUrl) elements.workerUrl.value = parsed.workerUrl;
            if (parsed.customBranch) {
              elements.branch.value = parsed.customBranch;
            } else if (parsed.branchSelect) {
              elements.branch.value = parsed.branchSelect;
            }
            if (parsed.adminKey) elements.adminKey.value = parsed.adminKey;
          } catch (err) {
            console.warn("Shared settings konnten nicht gelesen werden", err);
          }
        }
      }

      function persistSettings() {
        const values = {
          workerUrl: elements.workerUrl.value,
          branch: elements.branch.value,
          adminKey: elements.adminKey.value,
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(values));
      }

      function initEvents() {
        elements.playerSearch.addEventListener("input", () => {
          renderPlayerTable();
        });
        elements.renameBtn.addEventListener("click", () => applyPlayerRename());
        elements.addAliasBtn.addEventListener("click", () => addAlias());
        if (elements.addAbsenceBtn) {
          elements.addAbsenceBtn.addEventListener("click", () => addAbsenceForSelectedPlayer());
        }
        if (elements.showAllAbsencesBtn) {
          elements.showAllAbsencesBtn.addEventListener("click", () => showAllAbsencesForSelectedPlayer());
        }
        elements.reloadBtn.addEventListener("click", () => reloadData());
        elements.saveBtn.addEventListener("click", () => saveChanges());
        elements.workerUrl.addEventListener("change", persistSettings);
        elements.adminKey.addEventListener("change", persistSettings);
        elements.branch.addEventListener("change", persistSettings);
        if (elements.aliasesTabButton) {
          elements.aliasesTabButton.addEventListener("click", () => {
            state.activeDetailTab = "aliases";
            updateDetailTabs();
          });
        }
        if (elements.absencesTabButton) {
          elements.absencesTabButton.addEventListener("click", () => {
            state.activeDetailTab = "absences";
            updateDetailTabs();
          });
        }
        if (elements.closeAbsenceModal) {
          elements.closeAbsenceModal.addEventListener("click", () => closeAbsenceModal());
        }
        if (elements.absenceModal) {
          elements.absenceModal.addEventListener("click", event => {
            if (event.target === elements.absenceModal) {
              closeAbsenceModal();
            }
          });
        }
        elements.renameInput.addEventListener("keydown", ev => {
          if (ev.key === "Enter") {
            ev.preventDefault();
            applyPlayerRename();
          }
        });
      }

      restoreSettings();
      initEvents();
      reloadData();
    })();
  </script>
  <script src="admin.js"></script>
</body>
</html>
