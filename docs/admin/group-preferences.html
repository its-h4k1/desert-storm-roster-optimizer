<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <title>Gruppenpräferenzen verwalten</title>
  <link rel="stylesheet" href="admin.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
    }

    .admin-groupprefs {
      --density-font-size: 0.88rem;
      --density-head-font-size: 0.76rem;
      --density-cell-padding-y: 0.35rem;
      --density-cell-padding-x: 0.6rem;
      --density-input-padding-y: 0.35rem;
      --density-input-padding-x: 0.55rem;
      --density-control-gap: 0.65rem;
      --density-legend-font-size: 0.88rem;
      --density-legend-gap: 0.5rem;
      --density-help-padding: 0.55rem;
      --density-help-line-height: 1.35;
    }

    .admin-groupprefs.is-spacious {
      --density-font-size: 0.95rem;
      --density-head-font-size: 0.82rem;
      --density-cell-padding-y: 0.55rem;
      --density-cell-padding-x: 0.85rem;
      --density-input-padding-y: 0.5rem;
      --density-input-padding-x: 0.75rem;
      --density-control-gap: 0.85rem;
      --density-legend-font-size: 0.95rem;
      --density-legend-gap: 0.75rem;
      --density-help-padding: 0.8rem;
      --density-help-line-height: 1.45;
    }

    .page-header {
      background: var(--glass, rgba(255, 255, 255, 0.92));
      padding: 1.25rem clamp(1rem, 4vw, 2rem);
      border-radius: 1rem;
      border: 1px solid var(--border-strong, var(--border));
      box-shadow: var(--shadow-panel, 0 20px 45px rgba(15, 23, 42, 0.08));
      backdrop-filter: blur(18px);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
    }

    .page-header h1 {
      flex-basis: 100%;
      margin: 0;
      font-size: 1.45rem;
    }

    .page-header .settings {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
    }

    label {
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    input[type="text"],
    input[type="search"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      font: inherit;
      padding: 0.5rem 0.65rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-alt);
      color: var(--text);
      min-width: clamp(10rem, 24vw, 18rem);
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
    }

    input[type="search"] { min-width: 0; }

    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid rgba(37, 99, 235, 0.35);
      outline-offset: 1px;
    }

    button {
      font: inherit;
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.55rem 1.1rem;
      background: #fff;
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }

    button:hover { background: #f8fafc; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12); }
    button.secondary { background: var(--accent); border-color: var(--accent); color: #fff; }
    button.ghost { background: transparent; border-color: transparent; color: var(--accent); }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }

    .page-main {
      flex: 1;
      padding: 0;
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      align-items: start;
      width: 100%;
    }

    .panel {
      background: var(--panel);
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .panel h2 { margin: 0; font-size: 1.1rem; }

    .table-wrapper {
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      overflow-x: auto;
      background: var(--panel-muted);
    }

    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    thead { background: #f1f5f9; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.04em; }
    th, td { padding: 0.5rem 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
    tbody tr:nth-child(2n) { background: #f9fafc; }
    tbody tr:hover { background: rgba(37, 99, 235, 0.08); }
    tbody tr.inactive { opacity: 0.55; }

    .pill {
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.08);
      color: #0f172a;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .pill.ok { background: rgba(34, 197, 94, 0.15); color: #14532d; }
    .pill.err { background: rgba(239, 68, 68, 0.15); color: #7f1d1d; }

    .legend {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .legend strong { color: var(--text); display: block; margin-bottom: 0.35rem; }

    .status-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--glass, rgba(255, 255, 255, 0.9));
      border-top: 1px solid var(--border);
      padding: 0.55rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 -8px 20px rgba(15, 23, 42, 0.04);
    }

    .status-badge {
      font-size: 0.8rem;
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      background: #e2e8f0;
      color: #0f172a;
    }

    .status-ok { background: rgba(34, 197, 94, 0.14); color: #14532d; }
    .status-warn { background: rgba(234, 179, 8, 0.18); color: #854d0e; }
    .status-error { background: rgba(239, 68, 68, 0.14); color: #7f1d1d; }
    .status-info { background: rgba(59, 130, 246, 0.12); color: #1d4ed8; }

    .controls { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
    .controls .flex-spacer { flex: 1; min-width: 120px; }

    .help-box {
      border: 1px dashed var(--border);
      border-radius: 0.75rem;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.45);
    }

    .admin-groupprefs label {
      gap: 0.28rem;
      font-size: 0.82rem;
    }

    .admin-groupprefs input[type="text"],
    .admin-groupprefs input[type="search"],
    .admin-groupprefs input[type="password"],
    .admin-groupprefs input[type="number"],
    .admin-groupprefs select,
    .admin-groupprefs textarea {
      padding: var(--density-input-padding-y) var(--density-input-padding-x);
      min-width: clamp(8rem, 22vw, 15rem);
      font-size: 0.92rem;
    }

    .admin-groupprefs textarea {
      line-height: 1.3;
      resize: vertical;
    }

    .admin-groupprefs .controls { gap: var(--density-control-gap); }

    .admin-groupprefs table { font-size: var(--density-font-size); }
    .admin-groupprefs thead { font-size: var(--density-head-font-size); letter-spacing: 0.05em; }
    .admin-groupprefs th,
    .admin-groupprefs td { padding: var(--density-cell-padding-y) var(--density-cell-padding-x); }
    .admin-groupprefs tbody tr:hover { background: rgba(37, 99, 235, 0.06); }

    .admin-groupprefs td:nth-child(3) select { min-width: 9.5rem; }
    .admin-groupprefs td:nth-child(4) input[type="number"] {
      width: 6.5rem;
      min-width: 0;
      max-width: 6.5rem;
      text-align: right;
      font-variant-numeric: tabular-nums;
      padding-inline: calc(var(--density-input-padding-x) - 0.1rem);
    }
    .admin-groupprefs td:nth-child(5) textarea {
      min-height: 2.35rem;
      max-width: 22ch;
      padding-inline: calc(var(--density-input-padding-x) - 0.05rem);
      width: 100%;
    }
    .admin-groupprefs.is-spacious td:nth-child(5) textarea { min-height: 2.9rem; max-width: 26ch; }

    .admin-groupprefs .legend {
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: var(--density-legend-gap);
      font-size: var(--density-legend-font-size);
      line-height: 1.35;
    }

    .admin-groupprefs .legend strong {
      margin-bottom: 0.15rem;
      font-size: calc(var(--density-legend-font-size) + 0.05rem);
    }

    .admin-groupprefs .help-box {
      padding: var(--density-help-padding);
      background: rgba(255, 255, 255, 0.35);
      line-height: var(--density-help-line-height);
      display: grid;
      gap: 0.35rem;
    }

    @media (max-width: 900px) {
      .page-header { position: static; }
      table { font-size: 0.85rem; }
      label { width: 100%; }
      input[type="text"], input[type="password"], input[type="search"], select { width: 100%; }
      button { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="admin-shell">
    <aside class="admin-sidebar">
      <div class="admin-sidebar-header">
        <div class="admin-logo">ELT Admin</div>
        <button class="sidebar-close" aria-label="Navigation schließen">✕</button>
      </div>
      <nav class="admin-nav">
        <a href="index.html">CSV &amp; Datei-Tools</a>
        <a href="events.html">Events erfassen</a>
        <a href="players.html">Spieler &amp; Aliase</a>
        <a href="absences.html">Absenzen</a>
        <a href="group-preferences.html" class="active">Gruppenpräferenzen</a>
        <a href="event-assignments.html">Event-Zusagen</a>
        <a href="attendance-config.html">Attendance-Config</a>
        <a href="noshow-dashboard.html">No-Show Analyse</a>
        <a href="callup-assistant.html">Callup-Assistent</a>
      </nav>
    </aside>

    <div class="admin-main">
      <header class="admin-header">
        <button class="sidebar-toggle" aria-label="Navigation öffnen">☰</button>
        <div class="page-title">
          <p>Gruppenpräferenzen</p>
          <h1>Verwaltung</h1>
        </div>
        <div class="admin-header-actions">
          <a class="btn ghost" href="../index.html">Zur Roster-Ansicht</a>
        </div>
      </header>

        <main class="admin-content">
          <section class="admin-section page-wrapper admin-groupprefs">
            <div class="page-inner">
            <header class="page-header">
              <div style="flex:1;min-width:240px;">
                <h2>Gruppenpräferenzen verwalten</h2>
                <p style="margin:0;color:#6b7280;font-size:0.9rem">Pflege von <code>data/alliance.csv</code> (Spalten <code>PrefGroup</code>, <code>PrefMode</code>, <code>PrefBoost</code>).</p>
              </div>
              <div class="settings">
              <label>Worker URL
                <input id="workerUrl" type="text" value="https://ds-commit.hak1.workers.dev/write-file" spellcheck="false">
              </label>
              <label>Branch
                <input id="branchInput" type="text" value="main" spellcheck="false">
              </label>
              <label>Admin-Key
                <input id="adminKey" type="password" placeholder="r4-admin" autocomplete="off">
              </label>
              <button id="reloadBtn" class="ghost">Neu laden</button>
              <button id="saveBtn">Speichern</button>
            </div>
            </header>

            <main class="page-main">
            <section class="panel">
              <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
                <h2 style="margin-right:auto;">Allianz-Mitglieder</h2>
              <span class="pill" id="statsPill">–</span>
              <div class="help-box">
                <div class="legend">
                  <div><strong>Fest in A/B</strong> Harte Vorgabe (PrefMode = <code>hard</code>): Spieler muss in dieser Gruppe landen.</div>
                  <div><strong>Bevorzugt A/B</strong> Weiche Präferenz (PrefMode = <code>soft</code>): wird berücksichtigt, kann aber verletzt werden.</div>
                  <div><strong>Keine</strong> Kein Wunsch hinterlegt. <code>PrefGroup</code> und <code>PrefMode</code> bleiben leer.</div>
                  <div><strong>PrefBoost</strong> Optionaler Score-Bonus für die Wunschgruppe. Standard-Boost laut Optimizer-Logik.</div>
                </div>
              </div>
            </div>
            <div class="controls">
              <label style="flex:1;min-width:200px;">Suche
                <input type="search" id="searchInput" placeholder="Namen filtern…">
              </label>
              <div class="flex-spacer"></div>
              <label style="align-items:center;flex-direction:row;gap:0.5rem;">
                <input type="checkbox" id="activeOnly" checked>
                <span>Nur InAlliance = 1</span>
              </label>
              <label style="align-items:center;flex-direction:row;gap:0.5rem;">
                <input type="checkbox" id="compactToggle" checked>
                <span>Kompakte Ansicht</span>
              </label>
            </div>
            <div class="table-wrapper" aria-live="polite">
              <table>
                <thead>
                  <tr>
                    <th>Spieler</th>
                    <th>Status</th>
                    <th>Gruppenpräferenz</th>
                    <th>PrefBoost</th>
                    <th>Notiz</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
            </div>
            <div class="hint" id="emptyState" style="display:none;">Keine Spieler gefunden.</div>
          </section>
        </main>
          </div>
        </section>
      </main>
    </div>
  </div>
  <div class="admin-overlay"></div>

  <div class="status-bar">
    <span id="statusBadge" class="status-badge status-info">Bereit</span>
    <div id="statusText" class="status-text">Noch keine Änderungen.</div>
  </div>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="../shared.js"></script>
  <script>
    (function(){
      const elements = {
        root: document.querySelector(".admin-groupprefs"),
        workerUrl: document.getElementById("workerUrl"),
        branch: document.getElementById("branchInput"),
        adminKey: document.getElementById("adminKey"),
        reloadBtn: document.getElementById("reloadBtn"),
        saveBtn: document.getElementById("saveBtn"),
        searchInput: document.getElementById("searchInput"),
        activeOnly: document.getElementById("activeOnly"),
        compactToggle: document.getElementById("compactToggle"),
        tableBody: document.getElementById("tableBody"),
        emptyState: document.getElementById("emptyState"),
        statsPill: document.getElementById("statsPill"),
        statusBadge: document.getElementById("statusBadge"),
        statusText: document.getElementById("statusText"),
      };

      const state = {
        headers: [],
        rows: [],
        originalCsv: "",
        loading: false,
        saving: false,
        compact: true,
      };

      const SETTINGS_KEY = "dsro-group-pref-settings";
      const repoOwner = "its-h4k1";
      const repoName = "desert-storm-roster-optimizer";
      const defaultBranch = "main";
      const DEFAULT_HEADERS = ["PlayerName", "InAlliance", "Note", "PrefGroup", "PrefMode", "PrefBoost"];
      const PREF_OPTIONS = [
        { value: "none", label: "Keine" },
        { value: "hard-A", label: "Fest in A" },
        { value: "hard-B", label: "Fest in B" },
        { value: "soft-A", label: "Bevorzugt A" },
        { value: "soft-B", label: "Bevorzugt B" },
      ];
      const getAdminKey = () => (elements.adminKey.value || "").trim() || dsroShared.getAdminKey();

      function uiPrefToModel(value) {
        switch ((value || "none").toString()) {
          case "hard-A":
            return { prefGroup: "A", prefMode: "hard" };
          case "hard-B":
            return { prefGroup: "B", prefMode: "hard" };
          case "soft-A":
            return { prefGroup: "A", prefMode: "soft" };
          case "soft-B":
            return { prefGroup: "B", prefMode: "soft" };
          default:
            return { prefGroup: "", prefMode: "" };
        }
      }

      function modelToUiPref(prefGroup, prefMode) {
        const group = (prefGroup || "").toString().toUpperCase();
        const mode = (prefMode || "").toString().toLowerCase();
        if (mode === "hard" && (group === "A" || group === "B")) return `hard-${group}`;
        if (mode === "soft" && (group === "A" || group === "B")) return `soft-${group}`;
        return "none";
      }

      function normalizeLineEndings(text) {
        return (text || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
      }

      function ensureTrailingNewline(text) {
        if (!text) return "\n";
        return /\n$/.test(text) ? text : text + "\n";
      }

      function formatCsvValue(value) {
        if (value === null || value === undefined) return "";
        const str = value.toString();
        if (str.includes("\"") || str.includes(",") || str.includes("\n")) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      }

      function buildCsvFromRows(headers, rows) {
        const headerLine = headers.join(",");
        const lines = rows.map(row => headers.map(h => formatCsvValue(row[h] ?? "")).join(","));
        return ensureTrailingNewline([headerLine, ...lines].join("\n"));
      }

      function buildCandidatePaths(path) {
        const cleanPath = path.replace(/^\/+/, "");
        const prefixes = ["../../", "../", "./", ""];
        const candidates = prefixes.map(prefix => `${prefix}${cleanPath}`.replace(/\/+/g, "/"));
        const rawUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${defaultBranch}/${cleanPath}`;
        candidates.push(rawUrl);
        return candidates;
      }

      async function fetchFirstAvailable(urls) {
        for (const url of urls) {
          try {
            const response = await fetch(url, { cache: "no-store" });
            if (response.ok) return await response.text();
          } catch (err) {
            console.warn("Fetch-Fallback fehlgeschlagen", url, err);
          }
        }
        throw new Error(`Keine Quelle erreichbar (${urls.join(", ")})`);
      }

      function ensureHeaders(headers) {
        const list = (headers || []).filter(Boolean);
        DEFAULT_HEADERS.forEach(h => { if (!list.includes(h)) list.push(h); });
        return list;
      }

      function toBoolFlag(value) {
        return value === 1 || value === "1" || value === true || value === "true";
      }

      async function loadAlliance() {
        const paths = buildCandidatePaths("data/alliance.csv");
        const text = await fetchFirstAvailable(paths);
        const normalized = ensureTrailingNewline(normalizeLineEndings(text));
        state.originalCsv = normalized;
        const parsed = Papa.parse(normalized, { header: true, skipEmptyLines: false });
        const headers = ensureHeaders(parsed.meta.fields || []);
        state.headers = headers;
        const rows = parsed.data || [];
        state.rows = rows
          .filter(row => row && Object.values(row).some(v => (v ?? "").toString().trim() !== ""))
          .map((row, idx) => {
            const entry = { ...row };
            headers.forEach(h => { if (!(h in entry)) entry[h] = ""; });
            entry.PlayerName = (entry.PlayerName || "").trim();
            entry.PrefGroup = (entry.PrefGroup || "").toString().toUpperCase();
            entry.PrefMode = (entry.PrefMode || "").toString().toLowerCase();
            entry.PrefBoost = (entry.PrefBoost || "").toString();
            return { id: idx + 1, raw: entry };
          });
        renderTable();
        setStatus("Geladen.", "ok");
      }

      function setStatus(message, tone = "info") {
        const badge = elements.statusBadge;
        badge.className = "status-badge status-" + tone;
        badge.textContent = tone === "ok" ? "OK" : tone === "error" ? "Fehler" : tone === "warn" ? "Hinweis" : "Status";
        elements.statusText.textContent = message;
      }

      function setLoading(isLoading) {
        state.loading = isLoading;
        elements.reloadBtn.disabled = isLoading || state.saving;
        updateSaveButtonState();
        if (isLoading) setStatus("Lade Allianz…", "info");
      }

      function setSaving(isSaving) {
        state.saving = isSaving;
        updateSaveButtonState();
      }

      function updateSaveButtonState() {
        elements.saveBtn.disabled = state.loading || state.saving || !hasChanges();
        elements.saveBtn.textContent = state.saving ? "Speichert…" : "Speichern";
      }

      function applyDensityMode(isCompact) {
        state.compact = isCompact;
        if (elements.root) {
          elements.root.classList.toggle("is-spacious", !isCompact);
        }
      }

      function hasChanges() {
        const current = buildCurrentCsv();
        return normalizeLineEndings(current).trim() !== normalizeLineEndings(state.originalCsv).trim();
      }

      function buildCurrentCsv() {
        const headers = state.headers.length ? state.headers : [...DEFAULT_HEADERS];
        const rows = state.rows.map(entry => {
          const row = {};
          headers.forEach(h => { row[h] = entry.raw[h] ?? ""; });
          return row;
        });
        return buildCsvFromRows(headers, rows);
      }

      function getFilteredRows() {
        const query = (elements.searchInput.value || "").trim().toLowerCase();
        const activeOnly = elements.activeOnly.checked;
        const rows = state.rows || [];
        return rows
          .filter(row => {
            const name = (row.raw.PlayerName || "").toLowerCase();
            if (activeOnly && !toBoolFlag(row.raw.InAlliance)) return false;
            if (query && !name.includes(query)) return false;
            return true;
          })
          .sort((a, b) => (a.raw.PlayerName || "").localeCompare(b.raw.PlayerName || "", "de", { sensitivity: "base" }));
      }

      function updateStats() {
        const total = state.rows.length;
        const actives = state.rows.filter(r => toBoolFlag(r.raw.InAlliance)).length;
        const hard = state.rows.filter(r => r.raw.PrefMode === "hard" && ["A","B"].includes(r.raw.PrefGroup)).length;
        const soft = state.rows.filter(r => r.raw.PrefMode === "soft" && ["A","B"].includes(r.raw.PrefGroup)).length;
        elements.statsPill.textContent = `${actives}/${total} aktiv · ${hard} hard · ${soft} soft`;
      }

      function createSelect(options, value, onChange) {
        const select = document.createElement("select");
        options.forEach(opt => {
          const option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.label;
          if (opt.value === value) option.selected = true;
          select.appendChild(option);
        });
        select.addEventListener("change", (e) => onChange(e.target.value));
        return select;
      }

      function renderTable() {
        const tbody = elements.tableBody;
        tbody.innerHTML = "";
        const rows = getFilteredRows();
        if (!rows.length) {
          elements.emptyState.style.display = "block";
          updateStats();
          updateSaveButtonState();
          return;
        }
        elements.emptyState.style.display = "none";
        rows.forEach(entry => {
          const tr = document.createElement("tr");
          if (!toBoolFlag(entry.raw.InAlliance)) tr.classList.add("inactive");

          const nameTd = document.createElement("td");
          nameTd.textContent = entry.raw.PlayerName || "(unbenannt)";
          tr.appendChild(nameTd);

          const statusTd = document.createElement("td");
          const inAlliance = toBoolFlag(entry.raw.InAlliance);
          const pill = document.createElement("span");
          pill.className = `pill ${inAlliance ? 'ok' : 'err'}`;
          pill.textContent = inAlliance ? "In Allianz" : "Inaktiv";
          statusTd.appendChild(pill);
          tr.appendChild(statusTd);

          const prefTd = document.createElement("td");
          const prefSelect = createSelect(PREF_OPTIONS, modelToUiPref(entry.raw.PrefGroup, entry.raw.PrefMode), (val) => setPreference(entry.id, val));
          prefSelect.disabled = !inAlliance;
          prefTd.appendChild(prefSelect);
          tr.appendChild(prefTd);

          const boostTd = document.createElement("td");
          const boostInput = document.createElement("input");
          boostInput.type = "number";
          boostInput.min = "0";
          boostInput.max = "1";
          boostInput.step = "0.01";
          boostInput.value = entry.raw.PrefBoost ?? "";
          boostInput.placeholder = "0.05";
          boostInput.disabled = !inAlliance;
          boostInput.addEventListener("input", () => updateField(entry.id, "PrefBoost", boostInput.value));
          boostTd.appendChild(boostInput);
          tr.appendChild(boostTd);

          const noteTd = document.createElement("td");
          const noteInput = document.createElement("textarea");
          noteInput.value = entry.raw.Note ?? "";
          noteInput.rows = 1;
          noteInput.placeholder = "Notiz (optional)";
          noteInput.disabled = !inAlliance;
          noteInput.addEventListener("input", () => updateField(entry.id, "Note", noteInput.value));
          noteTd.appendChild(noteInput);
          tr.appendChild(noteTd);

          tbody.appendChild(tr);
        });
        updateStats();
        updateSaveButtonState();
      }

      function updateField(id, field, value) {
        const entry = state.rows.find(r => r.id === id);
        if (!entry) return;
        if (field === "PrefGroup") value = (value || "").toUpperCase();
        if (field === "PrefMode") value = (value || "").toLowerCase();
        entry.raw[field] = value;
        if (field === "PrefMode") {
          renderTable();
          return;
        }
        updateSaveButtonState();
      }

      function setPreference(id, uiValue) {
        const entry = state.rows.find(r => r.id === id);
        if (!entry) return;
        const { prefGroup, prefMode } = uiPrefToModel(uiValue);
        entry.raw.PrefGroup = prefGroup;
        entry.raw.PrefMode = prefMode;
        renderTable();
      }

      async function reloadData() {
        setLoading(true);
        try {
          await loadAlliance();
        } catch (err) {
          console.error(err);
          setStatus(`Laden fehlgeschlagen: ${err.message}`, "error");
        } finally {
          setLoading(false);
          updateSaveButtonState();
        }
      }

      async function saveChanges() {
        if (state.loading || state.saving) return;
        const workerUrl = elements.workerUrl.value.trim();
        const adminKey = getAdminKey();
        const branch = elements.branch.value.trim() || defaultBranch;
        if (!workerUrl) { setStatus("Worker-URL fehlt.", "error"); return; }
        if (!adminKey) { setStatus("Admin-Key erforderlich.", "error"); return; }
        const content = buildCurrentCsv();
        setSaving(true);
        setStatus("Speichere Präferenzen…", "info");
        try {
          await writeFile(workerUrl, adminKey, {
            path: "data/alliance.csv",
            content,
            branch,
            message: "admin: update alliance.csv via group preferences ui",
          });
          state.originalCsv = content;
          setStatus("Gespeichert.", "ok");
        } catch (err) {
          console.error(err);
          setStatus(`Speichern fehlgeschlagen: ${err.message}`, "error");
        } finally {
          setSaving(false);
          updateSaveButtonState();
        }
      }

      async function writeFile(workerUrl, adminKey, payload) {
        const headers = dsroShared.buildAdminHeaders({
          adminKey,
          headers: { "Content-Type": "application/json" },
        });
        const response = await fetch(workerUrl, {
          method: "POST",
          headers,
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          const text = await response.text().catch(() => "");
          throw new Error(text || `HTTP ${response.status}`);
        }
        const result = await response.json().catch(() => ({}));
        if (result && result.ok === false) {
          throw new Error(result.error || "Worker-Fehler");
        }
        return result;
      }

      function restoreSettings() {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            if (parsed.workerUrl) elements.workerUrl.value = parsed.workerUrl;
            if (parsed.branch) elements.branch.value = parsed.branch;
            if (parsed.adminKey) elements.adminKey.value = parsed.adminKey;
            return;
          } catch (err) { console.warn("Settings konnten nicht gelesen werden", err); }
        }
        const shared = localStorage.getItem("dsro-admin-settings");
        if (shared) {
          try {
            const parsed = JSON.parse(shared);
            if (parsed.workerUrl) elements.workerUrl.value = parsed.workerUrl;
            if (parsed.customBranch) { elements.branch.value = parsed.customBranch; }
            else if (parsed.branchSelect) { elements.branch.value = parsed.branchSelect; }
            if (parsed.adminKey) elements.adminKey.value = parsed.adminKey;
          } catch (err) { console.warn("Shared settings konnten nicht gelesen werden", err); }
        }
        dsroShared.saveAdminKey(elements.adminKey.value);
      }

      function persistSettings() {
        const values = {
          workerUrl: elements.workerUrl.value,
          branch: elements.branch.value,
          adminKey: elements.adminKey.value,
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(values));
        dsroShared.saveAdminKey(values.adminKey);
      }

      function initEvents() {
        elements.reloadBtn.addEventListener("click", () => reloadData());
        elements.saveBtn.addEventListener("click", () => saveChanges());
        elements.searchInput.addEventListener("input", () => renderTable());
        elements.activeOnly.addEventListener("change", () => renderTable());
        if (elements.compactToggle) {
          elements.compactToggle.addEventListener("change", () => applyDensityMode(elements.compactToggle.checked));
        }
        elements.workerUrl.addEventListener("change", persistSettings);
        elements.branch.addEventListener("change", persistSettings);
        elements.adminKey.addEventListener("change", persistSettings);
      }

      dsroShared.applyAdminKeyInput(elements.adminKey, { onChange: persistSettings });
      restoreSettings();
      initEvents();
      applyDensityMode(!elements.compactToggle || elements.compactToggle.checked !== false);
      reloadData();
    })();
  </script>
  <script src="admin.js"></script>
</body>
</html>
