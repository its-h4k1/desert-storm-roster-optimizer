<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Desert Storm – Matchday Roster</title>
  <style>
    :root { --fg:#1b1b1b; --muted:#6b7280; --line:#e5e7eb; --bg:#fff; --card:#f8fafc; }
    body { font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; margin:24px; color:var(--fg); background:var(--bg); }
    .page-header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:8px; }
    h1 { margin:0 0 6px; }
    h2 { margin:0 0 8px; }
    p { margin:0 0 10px; }
    .muted { color:var(--muted); }
    .grid { display:grid; gap:16px; grid-template-columns:1fr; }
    @media (min-width: 1024px) { .grid { grid-template-columns:repeat(2,1fr); } }
    .card { border:1px solid var(--line); border-radius:12px; padding:14px; background:var(--card); }
    .card h3 { margin:0 0 8px; }
    .list { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:0.85em; background:#fff; }
    .player { padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff; display:grid; grid-template-columns:42px 1fr; gap:10px; align-items:center; }
    .player-number { font-weight:700; color:var(--muted); text-align:center; }
    .player h4 { margin:0; font-size:1em; }
    .player .meta { margin:4px 0 0; font-size:0.9em; color:var(--muted); }
    .player-header { display:flex; align-items:center; gap:8px; justify-content:space-between; }
    .player-toggle { margin-left:auto; font-size:0.85em; padding:4px 8px; border-radius:8px; border:1px solid var(--line); background:var(--card); cursor:pointer; }
    .player-toggle:focus-visible { outline:2px solid #1d4ed8; outline-offset:2px; }
    .player-accordion { grid-column:1 / -1; border-top:1px solid var(--line); padding-top:8px; margin-top:8px; font-size:0.92em; }
    .accordion-events { list-style:none; padding:0; margin:0; display:grid; gap:6px; }
    .accordion-event-row { display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .accordion-date { font-weight:600; }
    .accordion-status { white-space:nowrap; }
    .section { margin:26px 0; }
    .tag { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; font-size:0.72em; border:1px solid var(--line); background:#eef2ff; color:#1d4ed8; }
    .error { border:1px solid #fecdd3; background:#fff5f5; color:#7f1d1d; padding:12px; border-radius:10px; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 14px; border-radius:10px; border:1px solid var(--line); background:#0f172a; color:white; text-decoration:none; font-weight:600; }
    .btn:hover { filter:brightness(0.95); }
    .btn:disabled { opacity:0.55; cursor:not-allowed; filter:none; }
    .top-no-show-entry { width:100%; text-align:left; border:1px solid var(--line); border-radius:10px; background:#fff; padding:10px; display:flex; align-items:center; justify-content:space-between; gap:12px; cursor:pointer; }
    .top-no-show-entry:hover { background:#f1f5f9; }
    .top-no-show-entry:focus-visible { outline:2px solid #1d4ed8; outline-offset:2px; }
    .top-no-show-details { display:flex; flex-direction:column; gap:4px; }
    .top-no-show-name { font-weight:600; }
    .top-no-show-meta { color:var(--muted); font-size:0.9em; }
  </style>
</head>
<body>
  <div class="page-header">
    <div>
      <h1>Desert Storm – Matchday Roster</h1>
      <p class="muted">Basis: harte Zusagen aus <code>data/event_signups_next.csv</code>. Teams A/B folgen direkt den Wünschen der Spieler, Überhänge landen getrennt pro Team.</p>
    </div>
    <a class="btn" href="admin/index.html">Admin &amp; Tools</a>
  </div>

  <div id="status" class="error" style="display:none"></div>

  <section id="event" class="section">
    <h2>Event</h2>
    <div id="event-meta" class="card">
      <p class="muted">Metadaten werden geladen …</p>
    </div>
    <div id="history-card" class="card" style="margin-top:12px;">
      <h3>Spieler-History</h3>
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px;">
        <input id="history-input" type="text" list="history-name-options" placeholder="Spieler suchen…" style="flex:1 1 220px;padding:8px;border-radius:10px;border:1px solid var(--line);" />
        <button id="history-button" class="btn" type="button">History anzeigen</button>
        <button id="history-clear" type="button" class="player-toggle" style="margin-left:0;">Clear</button>
      </div>
      <datalist id="history-name-options"></datalist>
      <div id="history-result" class="player-accordion" style="display:block;border:0;padding-top:0;margin-top:0;"></div>
    </div>
    <div id="top-no-shows-card" class="card" style="margin-top:12px;">
      <h3>Top No-Shows</h3>
      <p id="top-no-shows-meta" class="muted">seit reliability_start_date · minEvents=3 · TopK=8</p>
      <ul id="top-no-shows-list" class="list"></ul>
    </div>
  </section>

  <section id="teams" class="section">
    <h2>Teams</h2>
    <div class="grid">
      <div class="card">
        <h3 id="heading-team-a-start">Gruppe A · Start</h3>
        <ul id="team-a-start" class="list"></ul>
      </div>
      <div class="card">
        <h3 id="heading-team-b-start">Gruppe B · Start</h3>
        <ul id="team-b-start" class="list"></ul>
      </div>
    </div>

    <div class="section" style="margin-top:18px;">
      <h3>Ersatzbänke</h3>
      <div class="grid">
        <div class="card">
          <h4 id="heading-team-a-subs">Gruppe A · Ersatz</h4>
          <ul id="team-a-subs" class="list"></ul>
        </div>
        <div class="card">
          <h4 id="heading-team-b-subs">Gruppe B · Ersatz</h4>
          <ul id="team-b-subs" class="list"></ul>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <h3 id="heading-not-in-roster">Zugesagt (hard), aber nicht im Roster</h3>
      <ul id="not-in-roster" class="list"></ul>
    </div>
  </section>

  <script src="shared.js"></script>
  <script>
    const statusBox = document.getElementById('status');
    const eventMeta = document.getElementById('event-meta');
    const summaryBox = document.createElement('div');
    summaryBox.className = 'card';
    summaryBox.style.marginTop = '12px';
    const historyInput = document.getElementById('history-input');
    const historyButton = document.getElementById('history-button');
    const historyClearButton = document.getElementById('history-clear');
    const historyResultBox = document.getElementById('history-result');
    const historyNameOptions = document.getElementById('history-name-options');
    const topNoShowsList = document.getElementById('top-no-shows-list');
    const topNoShowsMeta = document.getElementById('top-no-shows-meta');
    const teamAStartList = document.getElementById('team-a-start');
    const teamASubsList = document.getElementById('team-a-subs');
    const teamBStartList = document.getElementById('team-b-start');
    const teamBSubsList = document.getElementById('team-b-subs');
    const notInRosterList = document.getElementById('not-in-roster');
    const headingTeamAStart = document.getElementById('heading-team-a-start');
    const headingTeamASubs = document.getElementById('heading-team-a-subs');
    const headingTeamBStart = document.getElementById('heading-team-b-start');
    const headingTeamBSubs = document.getElementById('heading-team-b-subs');
    const headingNotInRoster = document.getElementById('heading-not-in-roster');

    const state = {
      latestPayload: null,
      historyNameRegistry: [],
      historyUiWired: false,
    };

    const resolvePlayerName = (name) => {
      if (window.dsroShared?.resolvePlayerDisplayName) {
        return window.dsroShared.resolvePlayerDisplayName(name);
      }
      return name;
    };

    const resolvePlayerCanonical = (name) => {
      const shared = window.dsroShared || {};
      const canon = shared.canonicalNameJS ? shared.canonicalNameJS(name) : '';
      if (!canon) return '';
      const aliasMap = shared.aliasMap instanceof Map ? shared.aliasMap : null;
      return aliasMap?.get(canon) || canon;
    };

    const formatAttendanceLabel = (attended) => {
      if (attended === true) return '✅ Teilgenommen';
      if (attended === false) return '❌ No-Show';
      return '❔ Unbekannt';
    };

    const getPlayerEventHistoryIndex = () => {
      const shared = window.dsroShared || {};
      return shared.playerEventHistoryIndex instanceof Map ? shared.playerEventHistoryIndex : null;
    };

    function resolveHistoryDisplayName(name) {
      const shared = window.dsroShared || {};
      if (shared.resolvePlayerDisplayName) return shared.resolvePlayerDisplayName(name);
      const map = shared.canonicalDisplayMap instanceof Map ? shared.canonicalDisplayMap : null;
      if (map?.has(name)) return map.get(name);
      return name;
    }

    function buildRosterHistoryNameRegistry() {
      const shared = window.dsroShared || {};
      const registry = new Map();
      const aliasMap = shared.aliasMap instanceof Map ? shared.aliasMap : null;
      const displayMap = shared.canonicalDisplayMap instanceof Map ? shared.canonicalDisplayMap : null;
      const eventIndex = getPlayerEventHistoryIndex();

      const addEntry = (canon, display, raw) => {
        if (!canon) return;
        const key = canon;
        const existing = registry.get(key) || { canon: key, display: resolveHistoryDisplayName(display || key), raws: new Set() };
        existing.display = existing.display || resolveHistoryDisplayName(display || key);
        if (raw) existing.raws.add(String(raw).toLowerCase());
        registry.set(key, existing);
      };

      displayMap?.forEach((display, canon) => addEntry(canon, display, display));
      aliasMap?.forEach((target, alias) => {
        const resolved = target || alias;
        addEntry(resolved, displayMap?.get(resolved) || resolved, alias);
        addEntry(alias, displayMap?.get(resolved) || resolved, alias);
      });
      eventIndex?.forEach((_, canon) => addEntry(canon, displayMap?.get(canon) || canon));

      const payload = state.latestPayload || {};
      const addFromList = (list) => {
        (list || []).forEach((player) => {
          const name = player?.name || '';
          const canon = resolvePlayerCanonical(name);
          addEntry(canon, resolvePlayerName(name), name);
        });
      };
      addFromList(payload.team_a?.start);
      addFromList(payload.team_a?.subs);
      addFromList(payload.team_b?.start);
      addFromList(payload.team_b?.subs);
      addFromList(payload.hard_signups_not_in_roster);

      state.historyNameRegistry = Array.from(registry.values());
      if (historyNameOptions) {
        historyNameOptions.innerHTML = '';
        state.historyNameRegistry.forEach((entry) => {
          const option = document.createElement('option');
          option.value = entry.display || entry.canon;
          historyNameOptions.appendChild(option);
        });
      }
      return state.historyNameRegistry;
    }

    function resolveHistoryLookupCanon(inputStr) {
      const trimmed = typeof inputStr === 'string' ? inputStr.trim() : '';
      if (!trimmed) return '';
      const shared = window.dsroShared || {};
      const canonFn = shared.canonicalNameJS;
      const aliasMap = shared.aliasMap instanceof Map ? shared.aliasMap : null;
      let canon = canonFn ? canonFn(trimmed) : '';
      if (canon && aliasMap?.has(canon)) {
        canon = aliasMap.get(canon) || canon;
      }
      if (canon) return canon;

      const lower = trimmed.toLowerCase();
      const registryHit = state.historyNameRegistry.find(
        (entry) => entry.canon?.toLowerCase() === lower || entry.display?.toLowerCase() === lower || entry.raws?.has(lower),
      );
      return registryHit?.canon || '';
    }

    function findRosterElementByCanon(canonKey) {
      if (!canonKey || !document.querySelector) return null;
      const selectorValue = window.CSS?.escape ? window.CSS.escape(canonKey) : canonKey;
      try {
        return document.querySelector(`.player[data-canon="${selectorValue}"]`);
      } catch (err) {
        console.warn('Selector failed for canon key', err);
        return null;
      }
    }

    function renderHistoryLookupResult(canonKey) {
      if (!historyResultBox) return;
      const shared = window.dsroShared || {};
      const meta = shared.reliabilityMeta || {};
      const startLabel = meta.startDateRaw || shared.reliabilityStartDate || 'unbekannt';
      historyResultBox.innerHTML = '';

      if (meta.error) {
        historyResultBox.innerHTML = `<div class="muted">${meta.scopeLabel || 'Keine Event-Results geladen.'}</div>`;
        return;
      }

      const resultsLoaded =
        meta.eventResultsLoaded ?? (Array.isArray(shared.reliabilityEventResults) ? shared.reliabilityEventResults.length : 0);
      if (!resultsLoaded) {
        historyResultBox.innerHTML = '<div class="muted">Keine Event-Results geladen.</div>';
        return;
      }

      if (!canonKey) {
        historyResultBox.innerHTML = '<div class="muted">Kein Treffer / keine Daten.</div>';
        return;
      }

      const displayName = resolveHistoryDisplayName(canonKey) || canonKey;
      const stats = shared.getPlayerReliability ? shared.getPlayerReliability(canonKey) : null;
      const events = getPlayerEventHistoryIndex()?.get(canonKey) || [];

      const header = document.createElement('div');
      header.innerHTML = `<h4 style="margin:0 0 4px;">${displayName}</h4><div class="muted" style="margin-bottom:8px;">Seit Start: ${startLabel}</div>`;
      historyResultBox.appendChild(header);

      if (stats && typeof stats === 'object') {
        const summaryParts = [];
        if (typeof stats.events === 'number') summaryParts.push(`Events: ${stats.events}`);
        if (typeof stats.attendance === 'number') summaryParts.push(`Attendance: ${stats.attendance}`);
        if (typeof stats.noShows === 'number') summaryParts.push(`No-Shows: ${stats.noShows}`);
        if (typeof stats.earlyCancels === 'number') summaryParts.push(`Early Cancels: ${stats.earlyCancels}`);
        if (typeof stats.lateCancels === 'number') summaryParts.push(`Late Cancels: ${stats.lateCancels}`);
        if (summaryParts.length) {
          const p = document.createElement('p');
          p.className = 'muted';
          p.style.marginBottom = '10px';
          p.textContent = summaryParts.join(' · ');
          historyResultBox.appendChild(p);
        }
      }

      if (!events.length) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = `Keine Event-Daten seit ${startLabel}.`;
        historyResultBox.appendChild(empty);
        return;
      }

      const list = document.createElement('ul');
      list.className = 'accordion-events';
      events.forEach((evt) => {
        const row = document.createElement('li');
        row.className = 'accordion-event-row';
        const statusLabel = formatAttendanceLabel(evt.attended);
        const dateLabel = evt.date || evt.eventId || 'Event';
        row.innerHTML = `<span class="accordion-date">${dateLabel}</span><span class="accordion-status">${statusLabel}</span>`;
        list.appendChild(row);
      });
      historyResultBox.appendChild(list);

      const rosterElement = findRosterElementByCanon(canonKey);
      if (rosterElement) {
        const link = document.createElement('button');
        link.type = 'button';
        link.className = 'player-toggle';
        link.style.marginTop = '10px';
        link.textContent = 'Im Roster anzeigen';
        link.addEventListener('click', () => {
          rosterElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          rosterElement.style.transition = 'background-color 0.6s ease';
          const originalBg = rosterElement.style.backgroundColor;
          rosterElement.style.backgroundColor = '#fef3c7';
          setTimeout(() => {
            rosterElement.style.backgroundColor = originalBg || '#fff';
          }, 800);
        });
        historyResultBox.appendChild(link);
      }
    }

    function wireHistoryLookupUI() {
      if (state.historyUiWired || !historyInput || !historyButton) return;
      state.historyUiWired = true;
      historyResultBox.innerHTML = '<div class="muted">Kein Treffer / keine Daten.</div>';
      const triggerLookup = () => {
        const canon = resolveHistoryLookupCanon(historyInput.value || '');
        renderHistoryLookupResult(canon);
      };
      historyButton.addEventListener('click', triggerLookup);
      historyInput.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          triggerLookup();
        }
      });
      if (historyClearButton) {
        historyClearButton.addEventListener('click', () => {
          historyInput.value = '';
          historyResultBox.innerHTML = '<div class="muted">Kein Treffer / keine Daten.</div>';
        });
      }
    }

    function renderPlayerAccordion(accordion, canonicalKey) {
      const shared = window.dsroShared || {};
      const eventIndex = getPlayerEventHistoryIndex();
      const startLabel = shared.reliabilityMeta?.startDateRaw || shared.reliabilityStartDate || 'unbekannt';
      accordion.innerHTML = '';

      if (!Array.isArray(shared.reliabilityEventResults) || shared.reliabilityEventResults.length === 0) {
        accordion.innerHTML = '<div class="muted">Keine Event-Results geladen.</div>';
        return;
      }

      if (!canonicalKey) {
        accordion.innerHTML = '<div class="muted">Keine Event-Daten gefunden.</div>';
        return;
      }

      const events = eventIndex?.get(canonicalKey) || [];
      if (!events.length) {
        accordion.innerHTML = `<div class="muted">Keine Event-Daten seit ${startLabel}.</div>`;
        return;
      }

      const list = document.createElement('ul');
      list.className = 'accordion-events';

      events.forEach((evt) => {
        const row = document.createElement('li');
        row.className = 'accordion-event-row';
        const statusLabel = formatAttendanceLabel(evt.attended);
        const dateLabel = evt.date || evt.eventId || 'Event';
        row.innerHTML = `<span class="accordion-date">${dateLabel}</span><span class="accordion-status">${statusLabel}</span>`;
        list.appendChild(row);
      });

      accordion.appendChild(list);
    }

    function renderTopNoShowsCard() {
      if (!topNoShowsList || !topNoShowsMeta) return;
      const shared = window.dsroShared || {};
      const meta = shared.reliabilityMeta || {};
      const startLabel = meta.startDateRaw || shared.reliabilityStartDate || 'unbekannt';
      const minEvents = Number.isFinite(shared.REL_MIN_EVENTS_FOR_BUCKET)
        ? shared.REL_MIN_EVENTS_FOR_BUCKET
        : 3;
      const topK = 8;
      topNoShowsMeta.textContent = `seit ${startLabel} · minEvents=${minEvents} · TopK=${topK}`;
      topNoShowsList.innerHTML = '';

      const resultsLoaded =
        meta.eventResultsLoaded ?? (Array.isArray(shared.reliabilityEventResults) ? shared.reliabilityEventResults.length : 0);
      if (meta.error || !resultsLoaded) {
        topNoShowsList.innerHTML = '<li class="muted">Noch keine Daten.</li>';
        return;
      }

      const historyIndex = getPlayerEventHistoryIndex();
      if (!historyIndex || historyIndex.size === 0 || !shared.computeTopNoShowsFromHistoryIndex) {
        topNoShowsList.innerHTML = '<li class="muted">Noch keine Daten.</li>';
        return;
      }

      const list = shared.computeTopNoShowsFromHistoryIndex(historyIndex, { minEvents, topK });
      if (!list.length) {
        topNoShowsList.innerHTML = '<li class="muted">Noch keine Daten.</li>';
        return;
      }

      list.forEach((entry) => {
        const li = document.createElement('li');
        const ratePercent = Math.round(entry.rate * 100);
        const lastNoShow = entry.lastNoShowEventId || '–';
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'top-no-show-entry';
        button.innerHTML = `
          <div class="top-no-show-details">
            <span class="top-no-show-name">${entry.display || entry.canon}</span>
            <span class="top-no-show-meta">Letzter No-Show: ${lastNoShow}</span>
          </div>
          <div class="top-no-show-meta">${entry.noShows}/${entry.total} · ${ratePercent}%</div>
        `;
        button.addEventListener('click', () => {
          if (historyInput) {
            historyInput.value = entry.display || entry.canon || '';
          }
          renderHistoryLookupResult(entry.canon);
        });
        li.appendChild(button);
        topNoShowsList.appendChild(li);
      });
    }

    function showError(message) {
      statusBox.textContent = message;
      statusBox.style.display = 'block';
    }

    function renderEvent(event) {
      const parts = [];
      if (event.id) parts.push(`<strong>ID:</strong> ${event.id}`);
      if (event.date) parts.push(`<strong>Datum:</strong> ${event.date}`);
      if (event.time) parts.push(`<strong>Zeit:</strong> ${event.time}`);
      if (event.generated_at) parts.push(`<span class="pill">Build: ${event.generated_at}</span>`);
      parts.push(`<span class="pill">Quelle: ${event.source || 'event_signups_next.csv'}</span>`);
      eventMeta.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">${parts.join(' ')}</div>`;
      if (!eventMeta.nextElementSibling || eventMeta.nextElementSibling !== summaryBox) {
        eventMeta.insertAdjacentElement('afterend', summaryBox);
      }
    }

    function formatHeading(element, label, count) {
      element.textContent = `${label} (${count} Spieler)`;
    }

    function renderSummary(counts) {
      const total = counts.teamAStart + counts.teamASubs + counts.teamBStart + counts.teamBSubs + counts.notInRoster;
      summaryBox.innerHTML = `<strong>Harte Zusagen gesamt:</strong> ${total}<br />A: ${counts.teamAStart} Start + ${counts.teamASubs} Ersatz · B: ${counts.teamBStart} Start + ${counts.teamBSubs} Ersatz · nicht im Roster: ${counts.notInRoster}`;
    }

    function renderList(container, entries) {
      container.innerHTML = '';
      if (!entries || entries.length === 0) {
        container.innerHTML = '<li class="muted">Keine Einträge</li>';
        return;
      }
      entries.forEach((player, index) => {
        const li = document.createElement('li');
        li.className = 'player';
        const displayName = resolvePlayerName(player.name);
        const tags = (player.tags || []).map((t) => `<span class="tag">${t}</span>`).join('');
        const canonicalKey = resolvePlayerCanonical(player.name);
        if (canonicalKey) li.dataset.canon = canonicalKey;
        const accordionId = `accordion-${container.id}-${index}`;
        li.innerHTML = `<div class="player-number">${index + 1}</div><div><div class="player-header"><h4>${displayName}${tags}</h4><button class="player-toggle" type="button" aria-expanded="false" aria-controls="${accordionId}">Details ▾</button></div><div class="meta">${player.role}${player.note ? ' · ' + player.note : ''}${player.source ? ' · Quelle: ' + player.source : ''}</div></div>`;
        const accordion = document.createElement('div');
        accordion.className = 'player-accordion';
        accordion.id = accordionId;
        accordion.style.display = 'none';
        renderPlayerAccordion(accordion, canonicalKey);
        const toggle = li.querySelector('.player-toggle');
        toggle.addEventListener('click', () => {
          const open = accordion.style.display === 'block';
          if (open) {
            accordion.style.display = 'none';
            toggle.setAttribute('aria-expanded', 'false');
            toggle.textContent = 'Details ▾';
          } else {
            accordion.style.display = 'block';
            toggle.setAttribute('aria-expanded', 'true');
            toggle.textContent = 'Details ▴';
          }
        });
        li.appendChild(accordion);
        container.appendChild(li);
      });
    }

    async function loadLatest() {
      try {
        const res = await fetch('out/latest.json?v=' + Date.now());
        if (!res.ok) throw new Error('latest.json HTTP ' + res.status);
        const data = await res.json();
        state.latestPayload = data;
        if (window.dsroShared?.prepareAliasMapFromPayload) {
          window.dsroShared.prepareAliasMapFromPayload(data);
        }
        if (window.dsroShared?.hydrateReliabilityFromPayload) {
          const siteRoot = window.dsroShared.computeSiteRoot
            ? window.dsroShared.computeSiteRoot(location.pathname || '/')
            : './';
          await window.dsroShared.hydrateReliabilityFromPayload(data, { siteRoot });
        }
        renderEvent(data.event || {});
        const counts = {
          teamAStart: data.team_a?.start?.length || 0,
          teamASubs: data.team_a?.subs?.length || 0,
          teamBStart: data.team_b?.start?.length || 0,
          teamBSubs: data.team_b?.subs?.length || 0,
          notInRoster: data.hard_signups_not_in_roster?.length || 0,
        };

        formatHeading(headingTeamAStart, 'Gruppe A · Start', counts.teamAStart);
        formatHeading(headingTeamASubs, 'Gruppe A · Ersatz', counts.teamASubs);
        formatHeading(headingTeamBStart, 'Gruppe B · Start', counts.teamBStart);
        formatHeading(headingTeamBSubs, 'Gruppe B · Ersatz', counts.teamBSubs);
        formatHeading(headingNotInRoster, 'Zugesagt (hard), aber nicht im Roster', counts.notInRoster);
        renderSummary(counts);

        renderList(teamAStartList, data.team_a?.start || []);
        renderList(teamASubsList, data.team_a?.subs || []);
        renderList(teamBStartList, data.team_b?.start || []);
        renderList(teamBSubsList, data.team_b?.subs || []);
        renderList(notInRosterList, data.hard_signups_not_in_roster || []);
        buildRosterHistoryNameRegistry();
        wireHistoryLookupUI();
        renderTopNoShowsCard();
      } catch (err) {
        console.error(err);
        showError('latest.json konnte nicht geladen werden – bitte Build prüfen.');
        state.latestPayload = null;
      }
    }

    loadLatest();
  </script>
</body>
</html>
