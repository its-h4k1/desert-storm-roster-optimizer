<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Desert Storm – Matchday Roster</title>
  <style>
    :root { --fg:#1b1b1b; --muted:#6b7280; --line:#e5e7eb; --bg:#fff; --card:#f8fafc; }
    body { font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; margin:24px; color:var(--fg); background:var(--bg); }
    .page-header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:8px; }
    h1 { margin:0 0 6px; }
    h2 { margin:0 0 8px; }
    p { margin:0 0 10px; }
    .muted { color:var(--muted); }
    .grid { display:grid; gap:16px; grid-template-columns:1fr; }
    @media (min-width: 1024px) { .grid { grid-template-columns:repeat(2,1fr); } }
    .card { border:1px solid var(--line); border-radius:12px; padding:14px; background:var(--card); }
    .card h3 { margin:0 0 8px; }
    .list { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:0.85em; background:#fff; }
    .player { padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff; display:grid; grid-template-columns:42px 1fr; gap:10px; align-items:center; }
    .player-number { font-weight:700; color:var(--muted); text-align:center; }
    .player h4 { margin:0; font-size:1em; }
    .player .meta { margin:4px 0 0; font-size:0.9em; color:var(--muted); }
    .player-header { display:flex; align-items:center; gap:8px; justify-content:space-between; }
    .player-heading { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .player-toggle { margin-left:auto; font-size:0.85em; padding:4px 8px; border-radius:8px; border:1px solid var(--line); background:var(--card); cursor:pointer; }
    .player-toggle:focus-visible { outline:2px solid #1d4ed8; outline-offset:2px; }
    .player-accordion { grid-column:1 / -1; border-top:1px solid var(--line); padding-top:8px; margin-top:8px; font-size:0.92em; }
    .accordion-summary { display:grid; gap:4px; margin-bottom:8px; }
    .accordion-summary .muted { color:var(--muted); }
    .accordion-events { list-style:none; padding:0; margin:0; display:grid; gap:6px; }
    .accordion-event-row { display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .accordion-date { font-weight:600; }
    .accordion-status { white-space:nowrap; }
    .section { margin:26px 0; }
    .tag { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; font-size:0.72em; border:1px solid var(--line); background:#eef2ff; color:#1d4ed8; }
    .error { border:1px solid #fecdd3; background:#fff5f5; color:#7f1d1d; padding:12px; border-radius:10px; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 14px; border-radius:10px; border:1px solid var(--line); background:#0f172a; color:white; text-decoration:none; font-weight:600; }
    .btn:hover { filter:brightness(0.95); }
    .btn:disabled { opacity:0.55; cursor:not-allowed; filter:none; }
    .reliability-badge { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:0.8em; border:1px solid var(--line); background:var(--card); }
    .reliability-hoch { color:#2e7d32; border-color:#c8e6c9; }
    .reliability-mittel { color:#f59e0b; border-color:#fde68a; }
    .reliability-niedrig { color:#b91c1c; border-color:#fecdd3; }
    .reliability-neu { color:#6b7280; border-color:var(--line); }
  </style>
</head>
<body>
  <div class="page-header">
    <div>
      <h1>Desert Storm – Matchday Roster</h1>
      <p class="muted">Basis: harte Zusagen aus <code>data/event_signups_next.csv</code>. Teams A/B folgen direkt den Wünschen der Spieler, Überhänge landen getrennt pro Team.</p>
    </div>
    <a class="btn" href="admin/index.html">Admin &amp; Tools</a>
  </div>

  <div id="status" class="error" style="display:none"></div>

  <section id="event" class="section">
    <h2>Event</h2>
    <div id="event-meta" class="card">
      <p class="muted">Metadaten werden geladen …</p>
    </div>
  </section>

  <section id="teams" class="section">
    <h2>Teams</h2>
    <div class="card" style="margin-bottom:14px;">
      <h3>Teilnahmelisten (Export fürs Ingame-Event)</h3>
      <p class="muted">Exportiert die Startaufstellungen als CSV (EventID, Slot, PlayerName, RoleAtRegistration).</p>
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
        <button id="export-team-a-start" class="btn" type="button" disabled title="Aktiviert sich, sobald die Startliste von Gruppe A geladen ist.">Teilnahmeliste A (Start) in Zwischenablage</button>
        <button id="export-team-b-start" class="btn" type="button" disabled title="Aktiviert sich, sobald die Startliste von Gruppe B geladen ist.">Teilnahmeliste B (Start) in Zwischenablage</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3 id="heading-team-a-start">Gruppe A · Start</h3>
        <ul id="team-a-start" class="list"></ul>
      </div>
      <div class="card">
        <h3 id="heading-team-b-start">Gruppe B · Start</h3>
        <ul id="team-b-start" class="list"></ul>
      </div>
    </div>

    <div class="section" style="margin-top:18px;">
      <h3>Ersatzbänke</h3>
      <div class="grid">
        <div class="card">
          <h4 id="heading-team-a-subs">Gruppe A · Ersatz</h4>
          <ul id="team-a-subs" class="list"></ul>
        </div>
        <div class="card">
          <h4 id="heading-team-b-subs">Gruppe B · Ersatz</h4>
          <ul id="team-b-subs" class="list"></ul>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <h3 id="heading-not-in-roster">Zugesagt (hard), aber nicht im Roster</h3>
      <ul id="not-in-roster" class="list"></ul>
    </div>
  </section>

  <script src="shared.js"></script>
  <script>
    const statusBox = document.getElementById('status');
    const eventMeta = document.getElementById('event-meta');
    const summaryBox = document.createElement('div');
    summaryBox.className = 'card';
    summaryBox.style.marginTop = '12px';
    const teamAStartList = document.getElementById('team-a-start');
    const teamASubsList = document.getElementById('team-a-subs');
    const teamBStartList = document.getElementById('team-b-start');
    const teamBSubsList = document.getElementById('team-b-subs');
    const notInRosterList = document.getElementById('not-in-roster');
    const headingTeamAStart = document.getElementById('heading-team-a-start');
    const headingTeamASubs = document.getElementById('heading-team-a-subs');
    const headingTeamBStart = document.getElementById('heading-team-b-start');
    const headingTeamBSubs = document.getElementById('heading-team-b-subs');
    const headingNotInRoster = document.getElementById('heading-not-in-roster');
    const exportTeamAStartButton = document.getElementById('export-team-a-start');
    const exportTeamBStartButton = document.getElementById('export-team-b-start');

    const escapeHtml = window.dsroShared?.escapeHtml || ((value) => (value == null
      ? ''
      : String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')));

    const ROLLING_WINDOW_SIZE = 5;
    const MIN_ROLLING_EVENTS = 3;

    const getRollingStats = (nameOrCanon) => {
      const shared = window.dsroShared || {};
      if (typeof shared.getRollingReliability !== 'function') return null;
      return shared.getRollingReliability(nameOrCanon, ROLLING_WINDOW_SIZE);
    };

    const buildRollingReliabilityBadge = (nameOrCanon) => {
      const shared = window.dsroShared || {};
      if (typeof shared.computeReliabilityBucket !== 'function') return '';
      const stats = getRollingStats(nameOrCanon);
      if (!stats) {
        return '<span class="reliability-badge reliability-neu" title="Keine Rolling-Daten">● Neu</span>';
      }
      const basis = stats.basisN ?? stats.events ?? 0;
      const bucketInfo = shared.computeReliabilityBucket(stats, {
        minEvents: MIN_ROLLING_EVENTS,
        insufficientTooltip: 'Zu wenig Rolling-Daten (Basis < 3).',
      });
      const tooltipBase = `Rolling (letzte ${stats.windowSize ?? ROLLING_WINDOW_SIZE}, Basis ${basis})`;
      const details = basis < MIN_ROLLING_EVENTS
        ? 'Zu wenig Rolling-Daten.'
        : `Attendance: ${stats.attendance ?? 0}/${stats.events ?? 0} · No-Shows: ${stats.noShows ?? 0}`;
      const tooltip = `${tooltipBase}: ${details}`;
      const badgeClass = `reliability-badge reliability-${bucketInfo.bucket || 'neu'}`;
      const label = bucketInfo.label || 'neu';
      return `<span class="${badgeClass}" title="${escapeHtml(tooltip)}">● ${escapeHtml(label)}</span>`;
    };

    const buildRollingSummaryRow = (canonicalKey) => {
      const stats = getRollingStats(canonicalKey);
      const windowSize = stats?.windowSize ?? ROLLING_WINDOW_SIZE;
      if (!stats) return '<div class="muted">Rolling: Keine Rolling-Daten</div>';
      const basis = stats.basisN ?? stats.events ?? 0;
      const prefix = `Rolling (letzte ${windowSize}, Basis ${basis})`;
      if (basis < MIN_ROLLING_EVENTS) {
        return `<div class="muted">${escapeHtml(prefix)}: zu wenig Rolling-Daten.</div>`;
      }
      const attendance = stats.attendance ?? 0;
      const events = stats.events ?? 0;
      const noShows = stats.noShows ?? 0;
      return `<div>${escapeHtml(prefix)}: ${attendance}/${events} · ${noShows} No-Shows</div>`;
    };

    const buildSinceStartSummaryRow = (canonicalKey) => {
      const shared = window.dsroShared || {};
      const startLabel = shared.reliabilityMeta?.startDateRaw || shared.reliabilityStartDate || 'reliability_start_date';
      if (shared.reliabilityError) {
        return `<div class="muted">Seit Start: ${escapeHtml(shared.reliabilityError)}</div>`;
      }
      const stats = typeof shared.getPlayerReliability === 'function'
        ? shared.getPlayerReliability(canonicalKey)
        : null;
      if (!stats) {
        return `<div class="muted">Seit Start (seit ${escapeHtml(startLabel)}): Keine Daten</div>`;
      }
      const attendance = stats.attendance ?? 0;
      const events = stats.events ?? 0;
      const noShows = stats.noShows ?? 0;
      return `<div>Seit Start (seit ${escapeHtml(startLabel)}, Basis ${events}): ${attendance}/${events} · ${noShows} No-Shows</div>`;
    };

    const state = {
      latestPayload: null,
    };

    const resolvePlayerName = (name) => {
      if (window.dsroShared?.resolvePlayerDisplayName) {
        return window.dsroShared.resolvePlayerDisplayName(name);
      }
      return name;
    };

    const resolvePlayerCanonical = (name) => {
      const shared = window.dsroShared || {};
      const canon = shared.canonicalNameJS ? shared.canonicalNameJS(name) : '';
      if (!canon) return '';
      const aliasMap = shared.aliasMap instanceof Map ? shared.aliasMap : null;
      return aliasMap?.get(canon) || canon;
    };

    const getPlayerEventHistoryIndex = () => {
      const shared = window.dsroShared || {};
      return shared.playerEventHistoryIndex instanceof Map ? shared.playerEventHistoryIndex : null;
    };

    function renderPlayerAccordion(accordion, canonicalKey) {
      const shared = window.dsroShared || {};
      const eventIndex = getPlayerEventHistoryIndex();
      const startLabel = shared.reliabilityMeta?.startDateRaw || shared.reliabilityStartDate || 'unbekannt';
      accordion.innerHTML = '';

      if (!Array.isArray(shared.reliabilityEventResults) || shared.reliabilityEventResults.length === 0) {
        accordion.innerHTML = '<div class="muted">Keine Event-Results geladen.</div>';
        return;
      }

      const summary = document.createElement('div');
      summary.className = 'accordion-summary';
      summary.innerHTML = `${buildRollingSummaryRow(canonicalKey)}${buildSinceStartSummaryRow(canonicalKey)}`;
      accordion.appendChild(summary);

      if (!canonicalKey) {
        accordion.innerHTML += '<div class="muted">Keine Event-Daten gefunden.</div>';
        return;
      }

      const events = eventIndex?.get(canonicalKey) || [];
      if (!events.length) {
        accordion.innerHTML += `<div class="muted">Keine Event-Daten seit ${escapeHtml(startLabel)}.</div>`;
        return;
      }

      const list = document.createElement('ul');
      list.className = 'accordion-events';

      events.forEach((evt) => {
        const row = document.createElement('li');
        row.className = 'accordion-event-row';
        const statusLabel = evt.attended ? '✅ Teilgenommen' : '❌ No-Show';
        const dateLabel = evt.date || evt.eventId || 'Event';
        row.innerHTML = `<span class="accordion-date">${dateLabel}</span><span class="accordion-status">${statusLabel}</span>`;
        list.appendChild(row);
      });

      accordion.appendChild(list);
    }

    function showError(message) {
      statusBox.textContent = message;
      statusBox.style.display = 'block';
    }

    function renderEvent(event) {
      const parts = [];
      if (event.id) parts.push(`<strong>ID:</strong> ${event.id}`);
      if (event.date) parts.push(`<strong>Datum:</strong> ${event.date}`);
      if (event.time) parts.push(`<strong>Zeit:</strong> ${event.time}`);
      if (event.generated_at) parts.push(`<span class="pill">Build: ${event.generated_at}</span>`);
      parts.push(`<span class="pill">Quelle: ${event.source || 'event_signups_next.csv'}</span>`);
      eventMeta.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">${parts.join(' ')}</div>`;
      if (!eventMeta.nextElementSibling || eventMeta.nextElementSibling !== summaryBox) {
        eventMeta.insertAdjacentElement('afterend', summaryBox);
      }
    }

    function formatHeading(element, label, count) {
      element.textContent = `${label} (${count} Spieler)`;
    }

    function renderSummary(counts) {
      const total = counts.teamAStart + counts.teamASubs + counts.teamBStart + counts.teamBSubs + counts.notInRoster;
      summaryBox.innerHTML = `<strong>Harte Zusagen gesamt:</strong> ${total}<br />A: ${counts.teamAStart} Start + ${counts.teamASubs} Ersatz · B: ${counts.teamBStart} Start + ${counts.teamBSubs} Ersatz · nicht im Roster: ${counts.notInRoster}`;
    }

    function renderList(container, entries) {
      container.innerHTML = '';
      if (!entries || entries.length === 0) {
        container.innerHTML = '<li class="muted">Keine Einträge</li>';
        return;
      }
      entries.forEach((player, index) => {
        const li = document.createElement('li');
        li.className = 'player';
        const displayName = resolvePlayerName(player.name);
        const tags = (player.tags || []).map((t) => `<span class="tag">${t}</span>`).join('');
        const canonicalKey = resolvePlayerCanonical(player.name);
        const reliabilityBadge = buildRollingReliabilityBadge(canonicalKey || player.name);
        const accordionId = `accordion-${container.id}-${index}`;
        li.innerHTML = `<div class="player-number">${index + 1}</div><div><div class="player-header"><div class="player-heading"><h4>${displayName}${tags}</h4>${reliabilityBadge}</div><button class="player-toggle" type="button" aria-expanded="false" aria-controls="${accordionId}">Details ▾</button></div><div class="meta">${player.role}${player.note ? ' · ' + player.note : ''}${player.source ? ' · Quelle: ' + player.source : ''}</div></div>`;
        const accordion = document.createElement('div');
        accordion.className = 'player-accordion';
        accordion.id = accordionId;
        accordion.style.display = 'none';
        renderPlayerAccordion(accordion, canonicalKey);
        const toggle = li.querySelector('.player-toggle');
        toggle.addEventListener('click', () => {
          const open = accordion.style.display === 'block';
          if (open) {
            accordion.style.display = 'none';
            toggle.setAttribute('aria-expanded', 'false');
            toggle.textContent = 'Details ▾';
          } else {
            accordion.style.display = 'block';
            toggle.setAttribute('aria-expanded', 'true');
            toggle.textContent = 'Details ▴';
          }
        });
        li.appendChild(accordion);
        container.appendChild(li);
      });
    }

    function formatCsvValue(value) {
      if (value === null || value === undefined) return '';
      const str = value.toString();
      if (str.includes('"') || str.includes(',') || str.includes('\n')) {
        return `"${str.replace(/"/g, '""')}"`;
      }
      return str;
    }

    function buildSimpleCsv(header, rows) {
      const lines = [];
      lines.push(header.join(','));
      rows.forEach((row) => {
        const cols = row.map((value) => formatCsvValue(value === undefined || value === null ? '' : value));
        lines.push(cols.join(','));
      });
      return lines.join('\n');
    }

    function hasStartList(groupKey) {
      const teamKey = groupKey === 'A' ? 'team_a' : 'team_b';
      const list = state.latestPayload?.[teamKey]?.start;
      return Array.isArray(list) && list.length > 0;
    }

    function getStartList(groupKey) {
      const teamKey = groupKey === 'A' ? 'team_a' : 'team_b';
      return state.latestPayload?.[teamKey]?.start || [];
    }

    function updateParticipationExportButtons() {
      const hasAStart = hasStartList('A');
      const hasBStart = hasStartList('B');
      exportTeamAStartButton.disabled = !hasAStart;
      exportTeamBStartButton.disabled = !hasBStart;
      exportTeamAStartButton.title = hasAStart
        ? 'Startliste A ist geladen. Klick kopiert die Teilnahmeliste (Starter) als CSV in die Zwischenablage.'
        : 'Aktiviert sich, sobald die Startliste von Gruppe A geladen ist.';
      exportTeamBStartButton.title = hasBStart
        ? 'Startliste B ist geladen. Klick kopiert die Teilnahmeliste (Starter) als CSV in die Zwischenablage.'
        : 'Aktiviert sich, sobald die Startliste von Gruppe B geladen ist.';
    }

    function promptParticipationEventIdForGroup(groupKey) {
      const suggestFn = window.dsroShared?.suggestDsEventIdForGroup;
      const suggestion = suggestFn ? suggestFn({ groupLetter: groupKey, payload: state.latestPayload }) : '';
      const input = prompt(`EventID für Gruppe ${groupKey} (z. B. DS-2025-12-12-${groupKey})`, suggestion || '');
      if (input === null) return '';
      return input.trim();
    }

    function exportParticipationCsvForGroup(groupKey) {
      if (!hasStartList(groupKey)) {
        alert(`Keine Startliste für Gruppe ${groupKey} vorhanden.`);
        return;
      }

      const eventId = promptParticipationEventIdForGroup(groupKey);
      if (!eventId) {
        alert(`Export für Gruppe ${groupKey} abgebrochen – keine EventID angegeben.`);
        return;
      }

      // Exportiert die Startaufstellung als DS-Event-Teilnahmeliste im Format EventID, Slot, PlayerName, RoleAtRegistration.
      const startList = getStartList(groupKey);
      const header = ['EventID', 'Slot', 'PlayerName', 'RoleAtRegistration'];
      const rows = startList.map((player, index) => [eventId, index + 1, resolvePlayerName(player.name) || '', 'Start']);
      const csv = buildSimpleCsv(header, rows);

      if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        navigator.clipboard
          .writeText(csv)
          .then(() => alert(`Teilnahmeliste ${groupKey} (Start) wurde in die Zwischenablage kopiert.`))
          .catch((err) => {
            console.error(err);
            alert('Kopieren der Teilnahmeliste in die Zwischenablage ist fehlgeschlagen.');
          });
      } else {
        alert('Die Clipboard-API ist in diesem Browser nicht verfügbar.');
      }
    }

    exportTeamAStartButton.addEventListener('click', () => exportParticipationCsvForGroup('A'));
    exportTeamBStartButton.addEventListener('click', () => exportParticipationCsvForGroup('B'));

    async function loadLatest() {
      try {
        const res = await fetch('out/latest.json?v=' + Date.now());
        if (!res.ok) throw new Error('latest.json HTTP ' + res.status);
        const data = await res.json();
        state.latestPayload = data;
        if (window.dsroShared?.prepareAliasMapFromPayload) {
          window.dsroShared.prepareAliasMapFromPayload(data);
        }
        if (window.dsroShared?.hydrateReliabilityFromPayload) {
          const siteRoot = window.dsroShared.computeSiteRoot
            ? window.dsroShared.computeSiteRoot(location.pathname || '/')
            : './';
          await window.dsroShared.hydrateReliabilityFromPayload(data, { siteRoot });
        }
        renderEvent(data.event || {});
        const counts = {
          teamAStart: data.team_a?.start?.length || 0,
          teamASubs: data.team_a?.subs?.length || 0,
          teamBStart: data.team_b?.start?.length || 0,
          teamBSubs: data.team_b?.subs?.length || 0,
          notInRoster: data.hard_signups_not_in_roster?.length || 0,
        };

        formatHeading(headingTeamAStart, 'Gruppe A · Start', counts.teamAStart);
        formatHeading(headingTeamASubs, 'Gruppe A · Ersatz', counts.teamASubs);
        formatHeading(headingTeamBStart, 'Gruppe B · Start', counts.teamBStart);
        formatHeading(headingTeamBSubs, 'Gruppe B · Ersatz', counts.teamBSubs);
        formatHeading(headingNotInRoster, 'Zugesagt (hard), aber nicht im Roster', counts.notInRoster);
        renderSummary(counts);

        renderList(teamAStartList, data.team_a?.start || []);
        renderList(teamASubsList, data.team_a?.subs || []);
        renderList(teamBStartList, data.team_b?.start || []);
        renderList(teamBSubsList, data.team_b?.subs || []);
        renderList(notInRosterList, data.hard_signups_not_in_roster || []);
        updateParticipationExportButtons();
      } catch (err) {
        console.error(err);
        showError('latest.json konnte nicht geladen werden – bitte Build prüfen.');
        state.latestPayload = null;
        updateParticipationExportButtons();
      }
    }

    loadLatest();
  </script>
</body>
</html>
