<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Desert Storm – Matchday Roster</title>
  <style>
    :root { --fg:#1b1b1b; --muted:#6b7280; --line:#e5e7eb; --bg:#fff; --card:#f8fafc; }
    body { font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; margin:24px; color:var(--fg); background:var(--bg); }
    .page-header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:8px; }
    h1 { margin:0 0 6px; }
    h2 { margin:0 0 8px; }
    p { margin:0 0 10px; }
    .muted { color:var(--muted); }
    .grid { display:grid; gap:16px; grid-template-columns:1fr; }
    @media (min-width: 1024px) { .grid { grid-template-columns:repeat(3,1fr); } }
    .card { border:1px solid var(--line); border-radius:12px; padding:14px; background:var(--card); }
    .card h3 { margin:0 0 8px; }
    .list { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:0.85em; background:#fff; }
    .player { padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff; }
    .player h4 { margin:0; font-size:1em; }
    .player .meta { margin:4px 0 0; font-size:0.9em; color:var(--muted); }
    .section { margin:26px 0; }
    .tag { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; font-size:0.72em; border:1px solid var(--line); background:#eef2ff; color:#1d4ed8; }
    .error { border:1px solid #fecdd3; background:#fff5f5; color:#7f1d1d; padding:12px; border-radius:10px; }
    .subheading { font-weight:600; margin:6px 0; color:#111827; }
    .team-split { display:grid; gap:12px; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 14px; border-radius:10px; border:1px solid var(--line); background:#0f172a; color:white; text-decoration:none; font-weight:600; }
    .btn:hover { filter:brightness(0.95); }
  </style>
</head>
<body>
  <div class="page-header">
    <div>
      <h1>Desert Storm – Matchday Roster</h1>
      <p class="muted">Basis: harte Zusagen aus <code>data/event_signups_next.csv</code>. Teams A/B folgen direkt den Wünschen der Spieler, Überhänge landen getrennt pro Team.</p>
    </div>
    <a class="btn" href="admin/index.html">Admin &amp; Tools</a>
  </div>

  <div id="status" class="error" style="display:none"></div>

  <section id="event" class="section">
    <h2>Event</h2>
    <div id="event-meta" class="card">
      <p class="muted">Metadaten werden geladen …</p>
    </div>
  </section>

  <section id="teams" class="section">
    <h2>Teams</h2>
    <div class="grid">
      <div class="card">
        <h3>Team A</h3>
        <div class="team-split">
          <div>
            <div class="subheading">Gruppe A · Start</div>
            <ul id="team-a-start" class="list"></ul>
          </div>
          <div>
            <div class="subheading">Gruppe A · Ersatz</div>
            <ul id="team-a-subs" class="list"></ul>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Team B</h3>
        <div class="team-split">
          <div>
            <div class="subheading">Gruppe B · Start</div>
            <ul id="team-b-start" class="list"></ul>
          </div>
          <div>
            <div class="subheading">Gruppe B · Ersatz</div>
            <ul id="team-b-subs" class="list"></ul>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Zugesagt (hard), aber nicht im Roster</h3>
        <ul id="not-in-roster" class="list"></ul>
      </div>
    </div>
  </section>

  <section id="analysis" class="section" style="display:none">
    <h2>Analyse &amp; Diagnose</h2>
    <p class="muted">Callup-/No-Show-Auswertungen sind getrennt vom Kern-Roster.</p>
    <pre id="analysis-block" style="white-space:pre-wrap;background:#0f172a;color:#e2e8f0;padding:12px;border-radius:10px;overflow:auto"></pre>
  </section>

  <script>
    const statusBox = document.getElementById('status');
    const eventMeta = document.getElementById('event-meta');
    const teamAStartList = document.getElementById('team-a-start');
    const teamASubsList = document.getElementById('team-a-subs');
    const teamBStartList = document.getElementById('team-b-start');
    const teamBSubsList = document.getElementById('team-b-subs');
    const notInRosterList = document.getElementById('not-in-roster');
    const analysisSection = document.getElementById('analysis');
    const analysisBlock = document.getElementById('analysis-block');

    function showError(message) {
      statusBox.textContent = message;
      statusBox.style.display = 'block';
    }

    function renderEvent(event) {
      const parts = [];
      if (event.id) parts.push(`<strong>ID:</strong> ${event.id}`);
      if (event.date) parts.push(`<strong>Datum:</strong> ${event.date}`);
      if (event.time) parts.push(`<strong>Zeit:</strong> ${event.time}`);
      if (event.generated_at) parts.push(`<span class="pill">Build: ${event.generated_at}</span>`);
      parts.push(`<span class="pill">Quelle: ${event.source || 'event_signups_next.csv'}</span>`);
      eventMeta.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">${parts.join(' ')}</div>`;
    }

    function renderList(container, entries) {
      container.innerHTML = '';
      if (!entries || entries.length === 0) {
        container.innerHTML = '<li class="muted">Keine Einträge</li>';
        return;
      }
      entries.forEach((player) => {
        const li = document.createElement('li');
        li.className = 'player';
        const tags = (player.tags || []).map((t) => `<span class="tag">${t}</span>`).join('');
        li.innerHTML = `<h4>${player.name}${tags}</h4><div class="meta">${player.role}${player.note ? ' · ' + player.note : ''}${player.source ? ' · Quelle: ' + player.source : ''}</div>`;
        container.appendChild(li);
      });
    }

    async function loadLatest() {
      try {
        const res = await fetch('out/latest.json?v=' + Date.now());
        if (!res.ok) throw new Error('latest.json HTTP ' + res.status);
        const data = await res.json();
        renderEvent(data.event || {});
        renderList(teamAStartList, data.team_a?.start || []);
        renderList(teamASubsList, data.team_a?.subs || []);
        renderList(teamBStartList, data.team_b?.start || []);
        renderList(teamBSubsList, data.team_b?.subs || []);
        renderList(notInRosterList, data.hard_signups_not_in_roster || []);

        if (data.analysis) {
          analysisSection.style.display = 'block';
          analysisBlock.textContent = JSON.stringify(data.analysis, null, 2);
        }
      } catch (err) {
        console.error(err);
        showError('latest.json konnte nicht geladen werden – bitte Build prüfen.');
      }
    }

    loadLatest();
  </script>
</body>
</html>
